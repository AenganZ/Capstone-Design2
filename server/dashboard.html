<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì¢…ì ì•Œë¦¼ ì‹œìŠ¤í…œ ê´€ë¦¬ì</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            color: #334155;
        }
        
        .header {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 70px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.disconnected {
            background: #ef4444;
        }
        
        .header-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            display: block;
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
            padding-top: 0;
            margin-top: 70px;
        }
        
        .sidebar {
            width: 400px;
            background: white;
            border-left: 1px solid #e2e8f0;
            overflow-y: auto;
            flex-shrink: 0;
            order: 2;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        /* ê°€ë¡œ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ (Chrome, Safari) */
        .tab-container::-webkit-scrollbar {
            height: 4px;
        }

        .tab-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .tab-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .tab-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s;
            white-space: nowrap; 
        }
        
        .tab-button.active {
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
            background: #f8fafc;
        }
        
        .tab-button:hover {
            background: #f1f5f9;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .content-area {
            flex: 1;
            height: 100%;
            order: 1;
            position: relative;
        }
        
        .map-placeholder {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .map-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: none;
        }
        
        .map-overlay > * {
            pointer-events: auto;
        }
        
        .map-status-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            font-size: 0.875rem;
        }
        
        .api-key-setup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 400px;
            text-align: center;
            z-index: 10;
        }
        
        .api-key-setup h3 {
            color: #1e293b;
            margin-bottom: 1rem;
        }
        
        .api-key-setup code {
            background: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .test-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .test-btn {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 120px;
        }
        
        .test-btn:hover {
            background: #f8fafc;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .test-btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .sidebar-section {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1e293b;
        }
        
        .person-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .person-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .person-item:hover {
            background: #f1f5f9;
            transform: translateX(2px);
        }
        
        .person-item.high-priority {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .person-item.selected {
            border-left-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }
        
        .person-item.new {
            animation: highlight 3s ease-out;
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        
        @keyframes highlight {
            0% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.5); }
            100% { box-shadow: none; }
        }
        
        .person-marker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            font-size: 0.8rem;
        }
        
        .person-marker.high {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .person-marker.medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .person-info {
            flex: 1;
            min-width: 0;
        }
        
        .person-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .person-details {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.4;
        }
        
        .risk-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        
        .risk-tag {
            background: #ef4444;
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .person-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .person-detail-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            margin: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .person-photo {
            width: 150px;
            height: 150px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        
        .person-photo.placeholder {
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 3rem;
        }
        
        .detail-section {
            margin-bottom: 1.5rem;
        }
        
        .detail-section h4 {
            color: #1f2937;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .detail-item {
            background: #f9fafb;
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
        }
        
        .detail-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        
        .detail-value {
            font-weight: 500;
            color: #1f2937;
        }
        
        .feature-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .feature-tag {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 16px;
            font-size: 0.75rem;
        }
        
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #f3f4f6;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .notification-panel {
            background: #f8fafc;
        }
        
        .notification-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-label {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }
        
        .form-input, .form-select {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .activity-log {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.875rem;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-time {
            color: #64748b;
            font-size: 0.75rem;
        }
        
        .activity-content {
            color: #1e293b;
            margin-top: 0.25rem;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: #6b7280;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 0.5%;
            left: 50%;
            transform: translateX(-50%) scale(0.9);
            opacity: 0;
            background: white;
            border-left: 4px solid #10b981;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1100;
            transition: all 0.3s ease;
            max-width: 400px;
            min-width: 300px;
        }

        .toast.show {
            transform: translate(-50%) scale(1);
            opacity: 1;
        }
        
        .toast.error {
            border-left-color: #ef4444;
        }
        
        .result-display {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .heatmap-controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .heatmap-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .heatmap-controls input[type="checkbox"] {
            margin: 0;
        }

        .heatmap-controls input[type="range"] {
            width: 100%;
            margin-top: 5px;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
        }

        .heatmap-controls input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }

        .heatmap-controls input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }

        .opacity-label {
            font-size: 0.7rem;
            color: #64748b;
            text-align: center;
            margin-top: 2px;
        }

        .driver-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .driver-status.online {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .driver-status.offline {
            background: #6b7280;
        }

        .cctv-video-player {
            background: #000;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: white;
            margin-top: 15px;
            position: relative;
        }

        .cctv-video-frame {
            width: 100%;
            height: 200px;
            background: #111;
            border: 2px solid #333;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .video-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .cctv-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .cctv-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .cctv-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .cctv-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.8rem;
        }

        .cctv-quality {
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .live-indicator {
            color: #ef4444;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        .server-status {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .server-status h4 {
            margin: 0 0 8px 0;
            color: #1e293b;
            font-size: 0.9rem;
        }

        .server-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .server-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .server-indicator.online {
            background: #10b981;
        }

        .server-indicator.offline {
            background: #ef4444;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
            }
            
            .content-area {
                height: 60vh;
            }
            
            .header-stats {
                display: none;
            }
        }
        .person-card {
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .person-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: #f3f4f6;
            color: #374151;
            font-size: 0.875rem;
            display: inline-block;
        }

        .category-badge {
            background: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }

        .stats-row {
            display: flex;
            gap: 1rem;
        }

        .stat-card {
            flex: 1;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .detail-label {
            font-weight: 500;
            color: #6b7280;
        }

        .detail-value {
            font-weight: 500;
            color: #1f2937;
        }

        .risk-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .risk-tag {
            background: #fee2e2;
            color: #991b1b;
            padding: 0.25rem 0.75rem;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .report-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .report-person-info {
            display: flex;
            gap: 12px;
        }

        .report-photo {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
        }

        .report-name {
            font-weight: 600;
            font-size: 15px;
        }

        .report-meta {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .report-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-PENDING { background: #fef3c7; color: #92400e; }
        .status-REVIEWING { background: #dbeafe; color: #1e40af; }
        .status-CONFIRMED { background: #d1fae5; color: #065f46; }
        .status-REJECTED { background: #fee2e2; color: #991b1b; }

        .report-content {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .report-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .report-actions button {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
        }

        .confidence-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .confidence-HIGH { background: #d1fae5; color: #065f46; }
        .confidence-MEDIUM { background: #fef3c7; color: #92400e; }
        .confidence-LOW { background: #e5e7eb; color: #374151; }

    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>
                <span class="status-indicator" id="connectionStatus"></span>
                ì‹¤ì¢…ì ì•Œë¦¼ ì‹œìŠ¤í…œ ê´€ë¦¬ì
            </h1>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-value" id="totalActive">0</span>
                    <span class="stat-label">í™œì„± ì‹¤ì¢…ì</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="highPriority">0</span>
                    <span class="stat-label">ê³ ìœ„í—˜êµ°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="onlineDrivers">0</span>
                    <span class="stat-label">ì˜¨ë¼ì¸ ê¸°ì‚¬</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="firebaseStatus">-</span>
                    <span class="stat-label">Firebase</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="tab-container">
                <button class="tab-button active" onclick="switchTab('missing')">ì‹¤ì¢…ì</button>
                <button class="tab-button" onclick="switchTab('drivers')">ê¸°ì‚¬ê´€ë¦¬</button>
                <button class="tab-button" onclick="switchTab('cctv')">CCTV</button>
                <button class="tab-button" onclick="switchTab('alert')">ì•Œë¦¼</button>
                <button class="tab-button" onclick="switchTab('reports')">ì‹¤ì¢…ì ì‹ ê³ </button>
                <button class="tab-button" onclick="switchTab('sighting')">ëª©ê²© ì‹ ê³ </button>
            </div>
            <div id="missing-tab" class="tab-content active">
                <div class="sidebar-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 class="section-title" style="margin-bottom: 0;">ì‹¤ì¢…ì ëª©ë¡</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="test-btn" style="padding: 4px 8px; font-size: 0.7rem;" onclick="admin.toggleAllPersons(true)">ì „ì²´ í‘œì‹œ</button>
                            <button class="test-btn" style="padding: 4px 8px; font-size: 0.7rem;" onclick="admin.toggleAllPersons(false)">ì „ì²´ ìˆ¨ê¹€</button>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <input type="text" 
                            class="form-input" 
                            id="missingPersonSearch" 
                            placeholder="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." 
                            onkeyup="searchMissingPersons()"
                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    </div>
                    <div class="person-list" id="personList">
                        <div class="loading">
                            <div class="spinner"></div>
                            ì‹¤ì¢…ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h2 class="section-title">ì‹¤ì‹œê°„ í™œë™</h2>
                    <div class="activity-log" id="activityLog">
                        <div class="activity-item">
                            <div class="activity-time">ì‹œìŠ¤í…œ ì‹œì‘</div>
                            <div class="activity-content">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="drivers-tab" class="tab-content">
                <div class="sidebar-section">
                    <h2 class="section-title">ë“±ë¡ëœ ê¸°ì‚¬ (ì‹¤ì‹œê°„)</h2>
                    <div class="person-list" id="driverList">
                        <div style="text-align: center; padding: 2rem; color: #9ca3af;">
                            ë“±ë¡ëœ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h2 class="section-title">ê¸°ì‚¬ ë“±ë¡</h2>
                    <form class="notification-form" id="driverForm">
                        <div class="form-group">
                            <label class="form-label">ê¸°ì‚¬ ì´ë¦„</label>
                            <input type="text" class="form-input" id="driverName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ì°¨ëŸ‰ ë²ˆí˜¸</label>
                            <input type="text" class="form-input" id="driverVehicle" placeholder="12ê°€3456" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ì—°ë½ì²˜</label>
                            <input type="tel" class="form-input" id="driverPhone" placeholder="010-1234-5678" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ì—…ì¢…</label>
                            <select class="form-select" id="driverType" required>
                                <option value="">ì—…ì¢… ì„ íƒ</option>
                                <option value="taxi">íƒì‹œ</option>
                                <option value="delivery">ë°°ë‹¬</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">ê¸°ì‚¬ ë“±ë¡</button>
                    </form>
                </div>
            </div>
            
            <div id="cctv-tab" class="tab-content">
                <div class="sidebar-section">
                    <h2 class="section-title">ì‹¤ì¢…ìë³„ CCTV ê´€ì œ</h2>
                    <div class="form-group">
                        <label class="form-label">ì‹¤ì¢…ì ì„ íƒ</label>
                        <select class="form-select" id="cctvPersonSelect" onchange="loadPersonCCTVs()">
                            <option value="">ì‹¤ì¢…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div id="cctvSearchInfo" style="display: none; margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <div id="cctvSearchRadius" style="font-size: 0.9rem; color: #1e40af; font-weight: 600; margin-bottom: 0.5rem;"></div>
                        <div id="cctvCount" style="font-size: 0.85rem; color: #1e40af; margin-bottom: 1rem;"></div>
                        <button onclick="openFullScreenCCTV()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.4); transition: all 0.2s;" 
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(102, 126, 234, 0.5)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(102, 126, 234, 0.4)';">
                            ì „ì²´ ë³´ê¸° (ê´€ì œì‹¤ ëª¨ë“œ)
                        </button>
                    </div>
                </div>
                
                <div class="content-area" style="padding: 1.5rem; overflow-y: auto;">
                    <div id="cctvGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(370px, 1fr)); gap: 1.5rem;">
                        <div style="text-align: center; padding: 4rem 2rem; color: #9ca3af; grid-column: 1/-1;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“¹</div>
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">ì‹¤ì¢…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                            <div style="font-size: 0.9rem;">ì„ íƒí•œ ì‹¤ì¢…ì ì£¼ë³€ì˜ ëª¨ë“  CCTVê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="alert-tab" class="tab-content">
                <div class="sidebar-section notification-panel">
                    <h2 class="section-title">ì‹¤ì¢…ìë³„ ë§ì¶¤ ì•Œë¦¼ ì „ì†¡</h2>
                    <form class="notification-form" id="notificationForm">
                        <div class="form-group">
                            <label class="form-label">ì‹¤ì¢…ì ì„ íƒ</label>
                            <select class="form-select" id="personSelect">
                                <option value="">ì‹¤ì¢…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ìˆ˜ìƒ‰ ë²”ìœ„ ì •ë³´</label>
                            <div id="searchRadiusInfo" style="padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 0.8rem; color: #1e40af;">
                                ì‹¤ì¢…ìë¥¼ ì„ íƒí•˜ë©´ ì—°êµ¬ ê¸°ë°˜ ìˆ˜ìƒ‰ ë²”ìœ„ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ë²”ìœ„ ë‚´ ê¸°ì‚¬ í˜„í™©</label>
                            <div id="driversInRange" style="padding: 10px; background: #f0fdf4; border-radius: 6px; font-size: 0.8rem; color: #15803d;">
                                ì‹¤ì¢…ìë¥¼ ì„ íƒí•˜ë©´ ë²”ìœ„ ë‚´ ê¸°ì‚¬ ìˆ˜ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ì•Œë¦¼ ë°©ì‹</label>
                            <select class="form-select" id="notificationType">
                                <option value="smart">ìŠ¤ë§ˆíŠ¸ ì „ì†¡ (ë²”ìœ„ ë‚´ ê¸°ì‚¬)</option>
                                <option value="test">í…ŒìŠ¤íŠ¸ ì „ì†¡</option>
                                <option value="all">ì „ì²´ ì „ì†¡</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">ì•Œë¦¼ ì „ì†¡</button>
                    </form>
                    <div id="notificationResult"></div>
                </div>
            </div>
            <!-- ëª©ê²© ì‹ ê³  íƒ­ -->
            <div id="sighting-tab" class="tab-content">
                <div class="content-area" style="padding-left: 2rem; padding-right: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 16px;">
                        <select id="reportStatusFilter" onchange="loadSightingReports(this.value)" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="all">ì „ì²´</option>
                            <option value="PENDING">ëŒ€ê¸°ì¤‘</option>
                            <option value="REVIEWING">ê²€í† ì¤‘</option>
                            <option value="CONFIRMED">í™•ì¸ë¨</option>
                            <option value="REJECTED">ê¸°ê°ë¨</option>
                        </select>
                        <button onclick="loadSightingReports(document.getElementById('reportStatusFilter').value)" style="padding: 8px 16px; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                    <div id="sightingReportsList" style="max-height: calc(100vh - 180px); overflow-y: auto;">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            ëª©ê²© ì‹ ê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                </div>
            </div>
            <div id="reports-tab" class="tab-content">
                <div class="sidebar-section">
                    <h2 class="section-title">ëŒ€ê¸° ì¤‘ì¸ ì‹ ê³  ëª©ë¡</h2>
                    <div class="stats-row" style="margin-bottom: 1rem;">
                        <div class="stat-card">
                            <div class="stat-value" id="pendingReportsCount">0</div>
                            <div class="stat-label">ëŒ€ê¸° ì¤‘</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="loadPendingReports()" style="margin-bottom: 1rem;">
                        ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    </button>
                    
                    <div class="person-list" id="pendingReportsList">
                        <div style="text-align: center; padding: 2rem; color: #9ca3af;">
                            ëŒ€ê¸° ì¤‘ì¸ ì‹ ê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h2 class="section-title">ìŠ¹ì¸ëœ ì‹¤ì¢…ì ê´€ë¦¬</h2>
                    <div class="form-group">
                        <label class="form-label">ì‹¤ì¢…ì ê²€ìƒ‰</label>
                        <input type="text" class="form-input" id="approvedPersonSearch" 
                               placeholder="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." onkeyup="searchApprovedPersons()">
                    </div>
                    
                    <div class="person-list" id="approvedPersonsList" style="max-height: 400px; overflow-y: auto;">
                        <div style="text-align: center; padding: 2rem; color: #9ca3af;">
                            ìŠ¹ì¸ëœ ì‹¤ì¢…ì ëª©ë¡
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="content-area">
            <div class="map-placeholder">
                <div style="position: absolute; top: 20px; left: 20px; z-index: 200;">
                    <div class="test-buttons">
                        <button class="test-btn" onclick="testAPI()">API í…ŒìŠ¤íŠ¸</button>
                        <button class="test-btn" onclick="testFirebase()">Firebase í…ŒìŠ¤íŠ¸</button>
                        <button class="test-btn" onclick="testStatistics()">í†µê³„ í™•ì¸</button>
                        <button class="test-btn" onclick="forceUpdate()">ìˆ˜ë™ ì—…ë°ì´íŠ¸</button>
                        <button class="test-btn" onclick="initKakaoMap()">ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™”</button>
                    </div>
                </div>
                
                <div class="map-overlay" id="mapOverlay" style="display: none; top: 20px; right: 20px; left: auto;">
                    <div class="server-status">
                        <h4>ì„œë²„ ìƒíƒœ</h4>
                        <div class="server-item">
                            <span class="server-indicator" id="mainServerStatus"></span>
                            <span>ë©”ì¸ ì„œë²„ (í¬íŠ¸ 8001)</span>
                        </div>
                        <div class="server-item">
                            <span class="server-indicator" id="firebaseServerStatus"></span>
                            <span>Firebase</span>
                        </div>
                    </div>
                    
                    <div class="heatmap-controls">
                        <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 0.9rem;">ìˆ˜ìƒ‰ ë²”ìœ„ íˆíŠ¸ë§µ</h4>
                        <label>
                            <input type="checkbox" id="showHeatmap" checked onchange="admin.toggleHeatmap()">
                            ìˆ˜ìƒ‰ ë²”ìœ„ í‘œì‹œ
                        </label>
                        <label>
                            <input type="checkbox" id="showDrivers" checked onchange="admin.toggleDriverVisibility()">
                            ê¸°ì‚¬ ìœ„ì¹˜ í‘œì‹œ
                        </label>
                        <label>
                            <input type="checkbox" id="showCCTVs" checked onchange="admin.toggleCCTVMarkers()">
                            CCTV ìœ„ì¹˜ í‘œì‹œ
                        </label>
                        <div style="margin-top: 8px;">
                            <label style="font-size: 0.8rem; color: #64748b; display: block; margin-bottom: 4px;">íˆíŠ¸ë§µ íˆ¬ëª…ë„ (max 70%)</label>
                            <input type="range" id="heatmapOpacity" min="0.01" max="0.7" step="0.01" value="0.15" onchange="admin.updateHeatmapOpacity()">
                            <div id="opacityValue" class="opacity-label">15%</div>
                        </div>
                    </div>
                    <div class="map-status-panel">
                        <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 0.9rem;">ì§€ë„ ìƒíƒœ</h4>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <span class="status-indicator" id="mapStatus"></span>
                            <span id="mapStatusText" style="font-size: 0.8rem;">ì§€ë„ ì¤€ë¹„ ì™„ë£Œ</span>
                        </div>
                        <div style="font-size: 0.75rem; color: #64748b;" id="markerCount">ë§ˆì»¤: 0ê°œ</div>
                        <div style="font-size: 0.75rem; color: #64748b;" id="driverCount">ì˜¨ë¼ì¸ ê¸°ì‚¬: 0ëª…</div>
                    </div>
                </div>
                
                <div id="map"></div>
                
                <div class="api-key-setup" id="apiKeySetup">
                    <h3>ì¹´ì¹´ì˜¤ ì§€ë„ ë¡œë”© ì¤‘...</h3>
                    <p>ì¹´ì¹´ì˜¤ ì§€ë„ë¥¼ ì´ˆê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                    <div style="margin-top: 1rem; text-align: center;">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <div id="testResults" class="result-display" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div class="person-detail-modal" id="personDetailModal">
        <div class="person-detail-content">
            <button class="close-modal" onclick="closePersonDetail()">Ã—</button>
            <div id="personDetailContent"></div>
        </div>
    </div>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_API_KEY&libraries=services"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8001';
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'reports') {
                loadPendingReports();
                loadApprovedPersons();
            } else if (tabName === 'cctv') {
                loadCCTVPersonList();
            }
        }

        function loadCCTVPersonList() {
            const select = document.getElementById('cctvPersonSelect');
            const persons = admin.getAllPersons();
            
            select.innerHTML = '<option value="">ì‹¤ì¢…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            persons.forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = `${person.name} (${person.age}ì„¸, ${person.gender})`;
                select.appendChild(option);
            });
        }

        function loadPersonCCTVs() {
            const select = document.getElementById('cctvPersonSelect');
            const personId = select.value;
            
            if (!personId) {
                document.getElementById('cctvSearchInfo').style.display = 'none';
                document.getElementById('cctvGrid').innerHTML = `
                    <div style="text-align: center; padding: 4rem 2rem; color: #9ca3af; grid-column: 1/-1;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“¹</div>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">ì‹¤ì¢…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                        <div style="font-size: 0.9rem;">ì„ íƒí•œ ì‹¤ì¢…ì ì£¼ë³€ì˜ ëª¨ë“  CCTVê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
                    </div>
                `;
                return;
            }
            
            const person = admin.getPersonById(personId);
            if (!person || !person.lat || !person.lng) {
                admin.showToast('ì‹¤ì¢…ìì˜ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            const radius = getSearchRadius(person.category);
            
            document.getElementById('cctvSearchInfo').style.display = 'block';
            document.getElementById('cctvSearchRadius').textContent = `ìˆ˜ìƒ‰ ë°˜ê²½: ${radius}m`;
            document.getElementById('cctvCount').textContent = 'CCTV ê²€ìƒ‰ ì¤‘...';
            
            document.getElementById('cctvGrid').innerHTML = `
                <div style="text-align: center; padding: 4rem 2rem; color: #9ca3af; grid-column: 1/-1;">
                    <div class="spinner" style="margin: 0 auto 1rem;"></div>
                    <div>CCTVë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                </div>
            `;
            
            fetch(`${API_BASE_URL}/api/search_cctv`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    lat: parseFloat(person.lat),
                    lng: parseFloat(person.lng),
                    radius: radius
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('cctvCount').textContent = `ê²€ìƒ‰ëœ CCTV: ${data.count}ê°œ`;
                displayCCTVGrid(data.cctvs);
                
                admin.addActivity({
                    time: new Date().toLocaleTimeString(),
                    content: `${person.name} ì£¼ë³€ CCTV ${data.count}ê°œ í‘œì‹œ`
                });
            })
            .catch(error => {
                console.error('CCTV ë¡œë“œ ì˜¤ë¥˜:', error);
                admin.showToast('CCTVë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                document.getElementById('cctvGrid').innerHTML = `
                    <div style="text-align: center; padding: 4rem 2rem; color: #ef4444; grid-column: 1/-1;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">ì˜¤ë¥˜ ë°œìƒ</div>
                        <div style="font-size: 0.9rem;">CCTVë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
            });
        }

        function displayCCTVGrid(cctvs) {
            const grid = document.getElementById('cctvGrid');
            
            if (!cctvs || cctvs.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 4rem 2rem; color: #9ca3af; grid-column: 1/-1;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ”</div>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">ì£¼ë³€ì— CCTVê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        <div style="font-size: 0.9rem;">ê²€ìƒ‰ ë²”ìœ„ë¥¼ í™•ëŒ€í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì‹¤ì¢…ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = cctvs.map(cctv => `
                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column;" 
                    onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.15)';" 
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                    
                    <div style="width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden; position: relative;">
                        <iframe 
                            src="${cctv.stream_url}" 
                            loading="eager"
                            style="width: 100%; height: 100%; border: none; display: block;" 
                            scrolling="no"
                            allowfullscreen>
                        </iframe>
                    </div>
                    
                    <div style="padding: 10px 12px; background: #4a5568; flex-shrink: 0;">
                        <div style="color: #60a5fa; font-size: 0.9rem; font-weight: 600; margin-bottom: 4px;">${cctv.name}</div>
                        <div style="font-size: 11px; color: #cbd5e0;">${cctv.address || 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ'}</div>
                        <div style="font-size: 10px; color: #a0aec0; font-family: monospace; margin-top: 2px; margin-bottom: 6px;">
                            ${cctv.coords.lat.toFixed(5)}, ${cctv.coords.lng.toFixed(5)}
                        </div>
                        <div style="font-size: 9px; color: #94a3b8; opacity: 0.8; padding-top: 6px; border-top: 1px solid rgba(203, 213, 224, 0.2);">
                            ê²½ì°°ì²­ ë„ì‹œêµí†µì •ë³´ì„¼í„°(UTIC) ì œê³µ
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getSearchRadius(category) {
            const radiusMap = {
                '061': 1600,
                '062': 3840,
                '063': 8000,
                'ë¯¸ì·¨í•™ì•„ë™': 1600,
                'ì´ˆë“±ì €í•™ë…„': 2500,
                'ì´ˆë“±ê³ í•™ë…„': 4000,
                'ì¤‘ê³ ë“±í•™ìƒ': 6500,
                'ì¹˜ë§¤í™˜ì': 3840,
                'ê³ ë ¹ì': 5000,
                'ì§€ì ì¥ì• ì¸': 2000,
                'ìíì¥ì• ì¸': 1800,
                'ì„±ì¸ê°€ì¶œ': 8000,
                'ê¸°íƒ€': 3000
            };
            return radiusMap[category] || 3000;
        }

        function loadCCTVPersonList() {
            const select = document.getElementById('cctvPersonSelect');
            const persons = admin.getAllPersons();
            
            select.innerHTML = '<option value="">ì‹¤ì¢…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            persons.forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = `${person.name} (${person.age}ì„¸, ${person.gender})`;
                select.appendChild(option);
            });
        }

        let currentCCTVs = [];

        function loadPersonCCTVs() {
            const select = document.getElementById('cctvPersonSelect');
            const personId = select.value;
            
            if (!personId) {
                document.getElementById('cctvSearchInfo').style.display = 'none';
                document.getElementById('cctvGrid').innerHTML = `
                    <div style="text-align: center; padding: 4rem 2rem; color: #9ca3af; grid-column: 1/-1;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“¹</div>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">ì‹¤ì¢…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                        <div style="font-size: 0.9rem;">ì„ íƒí•œ ì‹¤ì¢…ì ì£¼ë³€ì˜ ëª¨ë“  CCTVê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
                    </div>
                `;
                currentCCTVs = [];
                return;
            }
            
            const person = admin.getPersonById(personId);
            if (!person || !person.lat || !person.lng) {
                admin.showToast('ì‹¤ì¢…ìì˜ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            const radius = getSearchRadius(person.category);
            
            document.getElementById('cctvSearchInfo').style.display = 'block';
            document.getElementById('cctvSearchRadius').textContent = `ìˆ˜ìƒ‰ ë°˜ê²½: ${radius}m`;
            document.getElementById('cctvCount').textContent = 'CCTV ê²€ìƒ‰ ì¤‘...';
            
            document.getElementById('cctvGrid').innerHTML = `
                <div style="text-align: center; padding: 4rem 2rem; color: #9ca3af; grid-column: 1/-1;">
                    <div class="spinner" style="margin: 0 auto 1rem;"></div>
                    <div>CCTVë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                </div>
            `;
            
            fetch(`${API_BASE_URL}/api/search_cctv`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    lat: parseFloat(person.lat),
                    lng: parseFloat(person.lng),
                    radius: radius
                })
            })
            .then(response => response.json())
            .then(data => {
                currentCCTVs = data.cctvs || [];
                document.getElementById('cctvCount').textContent = `ê²€ìƒ‰ëœ CCTV: ${data.count}ê°œ`;
                displayCCTVGrid(currentCCTVs);
                
                admin.addActivity({
                    time: new Date().toLocaleTimeString(),
                    content: `${person.name} ì£¼ë³€ CCTV ${data.count}ê°œ í‘œì‹œ`
                });
            })
            .catch(error => {
                console.error('CCTV ë¡œë“œ ì˜¤ë¥˜:', error);
                admin.showToast('CCTVë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                currentCCTVs = [];
                document.getElementById('cctvGrid').innerHTML = `
                    <div style="text-align: center; padding: 4rem 2rem; color: #ef4444; grid-column: 1/-1;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">ì˜¤ë¥˜ ë°œìƒ</div>
                        <div style="font-size: 0.9rem;">CCTVë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
            });
        }

        function openFullScreenCCTV() {
            if (!currentCCTVs || currentCCTVs.length === 0) {
                admin.showToast('í‘œì‹œí•  CCTVê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            const count = currentCCTVs.length;
            let cols, rows;
            
            if (count <= 4) {
                cols = 2;
                rows = Math.ceil(count / 2);
            } else if (count <= 9) {
                cols = 3;
                rows = Math.ceil(count / 3);
            } else if (count <= 16) {
                cols = 4;
                rows = Math.ceil(count / 4);
            } else {
                cols = 5;
                rows = Math.ceil(count / 5);
            }
            
            const popup = window.open('', 'CCTVì „ì²´ê´€ì œ', 'width=1920,height=1080,fullscreen=yes');
            
            const gridItems = currentCCTVs.map(cctv => `
                <div style="background: #000; border-radius: 8px; overflow: hidden; position: relative; height: 100%;">
                    <iframe 
                        src="${cctv.stream_url}" 
                        style="width: 100%; height: 100%; border: none; display: block;" 
                        scrolling="no"
                        allowfullscreen>
                    </iframe>
                    <div style="position: absolute; top: 0; left: 0; right: 0; background: rgba(74, 85, 104, 0.9); padding: 8px 12px; backdrop-filter: blur(5px);">
                        <div style="color: #60a5fa; font-size: 0.85rem; font-weight: 600;">${cctv.name}</div>
                    </div>
                </div>
            `).join('');
            
            popup.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>CCTV í†µí•© ê´€ì œ</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            background: #0f172a; 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            overflow: hidden;
                            height: 100vh;
                            display: flex;
                            flex-direction: column;
                        }
                        .header {
                            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
                            color: white;
                            padding: 12px 20px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                            flex-shrink: 0;
                        }
                        .header h1 {
                            font-size: 1.2rem;
                            font-weight: 700;
                        }
                        .header .info {
                            font-size: 0.85rem;
                            opacity: 0.9;
                        }
                        .grid-container {
                            display: grid;
                            grid-template-columns: repeat(${cols}, 1fr);
                            grid-template-rows: repeat(${rows}, 1fr);
                            gap: 8px;
                            padding: 8px;
                            flex: 1;
                            min-height: 0;
                        }
                        .footer {
                            position: fixed;
                            bottom: 8px;
                            right: 8px;
                            background: rgba(0,0,0,0.8);
                            color: white;
                            padding: 6px 12px;
                            border-radius: 16px;
                            font-size: 10px;
                            backdrop-filter: blur(10px);
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>CCTV í†µí•© ê´€ì œ ì‹œìŠ¤í…œ</h1>
                        <div class="info">ì´ ${count}ê°œ CCTV ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</div>
                    </div>
                    <div class="grid-container">
                        ${gridItems}
                    </div>
                    <div class="footer">ê²½ì°°ì²­ ë„ì‹œêµí†µì •ë³´ì„¼í„°(UTIC) ì œê³µ</div>
                </body>
                </html>
            `);
        }

        function displayCCTVGrid(cctvs) {
            const grid = document.getElementById('cctvGrid');
            
            if (!cctvs || cctvs.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #9ca3af; grid-column: 1/-1;">
                        ì£¼ë³€ì— CCTVê°€ ì—†ìŠµë‹ˆë‹¤
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = cctvs.map(cctv => `
                <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="padding: 10px; background: #000;">
                        <iframe 
                            src="${cctv.stream_url}" 
                            style="width: 100%; height: 280px; border: none;" 
                            allowfullscreen>
                        </iframe>
                    </div>
                    <div style="padding: 10px 12px; background: #4a5568;">
                        <div style="color: #60a5fa; font-size: 0.9rem; font-weight: 600; margin-bottom: 4px;">${cctv.name}</div>
                        <div style="font-size: 11px; color: #cbd5e0;">${cctv.address || 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ'}</div>
                        <div style="font-size: 10px; color: #a0aec0; font-family: monospace; margin-top: 2px;">
                            ${cctv.coords.lat.toFixed(5)}, ${cctv.coords.lng.toFixed(5)}
                            ê²½ì°°ì²­ ë„ì‹œêµí†µì •ë³´ì„¼í„°(UTIC) ì œê³µ êµí†µì •ë³´
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getSearchRadius(category) {
            const radiusMap = {
                '061': 1600,
                '062': 3840,
                '063': 8000
            };
            return radiusMap[category] || 2000;
        }
        
        function registerDriver() {
            const name = document.getElementById('driverName').value;
            const vehicle = document.getElementById('driverVehicle').value;
            const phone = document.getElementById('driverPhone').value;
            const type = document.getElementById('driverType').value;
            
            if (!name || !vehicle || !phone || !type) {
                admin.showToast('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            admin.addActivity({
                time: new Date().toLocaleTimeString(),
                content: `ìƒˆ ê¸°ì‚¬ ë“±ë¡: ${name} (${admin.getDriverTypeName(type)})`
            });
            
            admin.showToast(`ê¸°ì‚¬ ${name}ë‹˜ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            document.getElementById('driverForm').reset();
        }
        
        async function searchNearbyCCTVs() {
            const selectedPerson = admin.getSelectedPerson();
            if (!selectedPerson) {
                admin.showToast('ì‹¤ì¢…ìë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (!selectedPerson.lat || !selectedPerson.lng) {
                admin.showToast('ì‹¤ì¢…ìì˜ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                console.error('ì„ íƒëœ ì‹¤ì¢…ì:', selectedPerson);
                return;
            }
            
            const radius = parseInt(document.getElementById('cctvRadius').value);
            
            admin.addActivity({
                time: new Date().toLocaleTimeString(),
                content: `${selectedPerson.name} ì£¼ë³€ ${radius}m ë°˜ê²½ CCTV ê²€ìƒ‰ ì‹œì‘`
            });
            
            console.log('CCTV ê²€ìƒ‰ ìš”ì²­:', {
                lat: selectedPerson.lat,
                lng: selectedPerson.lng,
                radius: radius
            });
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/search_cctv`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lat: parseFloat(selectedPerson.lat),
                        lng: parseFloat(selectedPerson.lng),
                        radius: radius
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:', errorData);
                    throw new Error(`CCTV ê²€ìƒ‰ ì‹¤íŒ¨: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('CCTV ê²€ìƒ‰ ê²°ê³¼:', data);
                displayCCTVList(data.cctvs);
                
                admin.addActivity({
                    time: new Date().toLocaleTimeString(),
                    content: `CCTV ${data.count}ê°œ ê²€ìƒ‰ ì™„ë£Œ`
                });
                
                admin.showToast(`ì£¼ë³€ CCTV ${data.count}ê°œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`, 'success');
                
            } catch (error) {
                console.error('CCTV ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                admin.showToast('CCTV ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                admin.addActivity({
                    time: new Date().toLocaleTimeString(),
                    content: 'CCTV ê²€ìƒ‰ ì‹¤íŒ¨'
                });
            }
        }

        function displayCCTVList(cctvs) {
            const container = document.getElementById('cctvList');
            
            if (!cctvs || cctvs.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #9ca3af;">ì£¼ë³€ì— CCTVê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            container.innerHTML = cctvs.map(cctv => {
                const statusColor = cctv.status === 'ì •ìƒ' ? '#10b981' : '#ef4444';
                const cctvDataEncoded = encodeURIComponent(JSON.stringify(cctv));
                
                return `
                    <div class="person-item" style="cursor: pointer;" onclick="showCCTVDetail('${cctv.id}', '${cctvDataEncoded}')">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">
                                ${cctv.name}
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">
                                ${cctv.address}
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <span style="display: inline-block; padding: 2px 8px; background: ${statusColor}20; color: ${statusColor}; border-radius: 4px; font-size: 0.7rem; font-weight: 500;">
                                    ${cctv.status}
                                </span>
                                <span style="display: inline-block; padding: 2px 8px; background: #3b82f620; color: #3b82f6; border-radius: 4px; font-size: 0.7rem;">
                                    ${cctv.type}
                                </span>
                            </div>
                        </div>
                        <div style="text-align: right; font-size: 0.75rem; color: #9ca3af;">
                            <i class="fas fa-video"></i>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showCCTVDetail(cctvId, cctvDataEncoded) {
            const container = document.getElementById('cctvDetail');
            const cctv = JSON.parse(decodeURIComponent(cctvDataEncoded));
            
            const statusColor = cctv.status === 'ì •ìƒ' ? '#10b981' : '#ef4444';
            
            container.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <h3 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                        ${cctv.name}
                    </h3>
                    <div style="display: flex; gap: 8px; margin-bottom: 1rem;">
                        <span style="display: inline-block; padding: 4px 12px; background: ${statusColor}20; color: ${statusColor}; border-radius: 6px; font-size: 0.75rem; font-weight: 500;">
                            ${cctv.status}
                        </span>
                        <span style="display: inline-block; padding: 4px 12px; background: #3b82f620; color: #3b82f6; border-radius: 6px; font-size: 0.75rem;">
                            ${cctv.type}
                        </span>
                    </div>
                </div>
                
                ${cctv.stream_url ? `
                    <div style="background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 1rem;">
                        <video id="cctvPlayer" 
                            style="width: 100%; height: auto; display: block;"
                            controls
                            autoplay
                            muted>
                            ë¸Œë¼ìš°ì €ê°€ HLS ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </video>
                    </div>
                ` : `
                    <div style="background: #f3f4f6; border-radius: 8px; padding: 3rem; text-align: center; color: #9ca3af; margin-bottom: 1rem;">
                        ìŠ¤íŠ¸ë¦¬ë° URLì´ ì—†ìŠµë‹ˆë‹¤
                    </div>
                `}
                
                <div style="font-size: 0.875rem; color: #6b7280; line-height: 1.6;">
                    <div style="margin-bottom: 0.5rem;">
                        <strong>ìœ„ì¹˜:</strong> ${cctv.address}
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <strong>ìš´ì˜ê¸°ê´€:</strong> ${cctv.operator}
                    </div>
                    ${cctv.resolution ? `
                        <div style="margin-bottom: 0.5rem;">
                            <strong>í•´ìƒë„:</strong> ${cctv.resolution}
                        </div>
                    ` : ''}
                    ${cctv.format ? `
                        <div style="margin-bottom: 0.5rem;">
                            <strong>í˜•ì‹:</strong> ${cctv.format}
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (cctv.stream_url) {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
                script.onload = function() {
                    const video = document.getElementById('cctvPlayer');
                    const url = cctv.stream_url;
                    
                    if (window.Hls && window.Hls.isSupported()) {
                        const hls = new window.Hls();
                        hls.loadSource(url);
                        hls.attachMedia(video);
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = url;
                    }
                };
                document.head.appendChild(script);
            }
            
            admin.addActivity({
                time: new Date().toLocaleTimeString(),
                content: `CCTV "${cctv.name}" ì˜ìƒ í™•ì¸`
            });
        }

        function controlCCTV(cctvId, action) {
            admin.addActivity({
                time: new Date().toLocaleTimeString(),
                content: `CCTV ${cctvId} ì œì–´ ëª…ë ¹ ì „ì†¡`
            });
            
            admin.showToast('CCTV ì œì–´ ëª…ë ¹ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.', 'success');
        }
        
        function requestCCTVFootage(cctvId) {
            admin.addActivity({
                time: new Date().toLocaleTimeString(),
                content: `CCTV ${cctvId} AI ì˜ìƒ ë¶„ì„ ìš”ì²­`
            });
            
            admin.showToast('AI ì˜ìƒ ë¶„ì„ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function closePersonDetail() {
            const modal = document.getElementById('personDetailModal');
            modal.style.display = 'none';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            // ì‹¤ì¢…ì ì‹ ê³  íƒ­ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const reportsTabButton = document.querySelector('[onclick="switchTab(\'reports\')"]');
            if (reportsTabButton) {
                reportsTabButton.addEventListener('click', function() {
                    console.log('ì‹¤ì¢…ì ì‹ ê³  íƒ­ í´ë¦­ë¨');
                    setTimeout(() => {
                        loadPendingReports();
                        loadApprovedPersons();
                    }, 100);
                });
            }
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            const modal = document.getElementById('personDetailModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePersonDetail();
                    }
                });
            }
        });

        async function showPersonDetail(personId) {
            console.log('ìƒì„¸ ì •ë³´ í‘œì‹œ:', personId);  // ë””ë²„ê¹…ìš©
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/person/${personId}`);
                const person = await response.json();
                
                if (!response.ok) {
                    admin.showToast('ì‹¤ì¢…ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                const modal = document.getElementById('personDetailModal');
                const content = document.getElementById('personDetailContent');
                
                // HTML ìƒì„± (ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
                content.innerHTML = `
                    <div style="display: flex; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            ${(() => {
                                const photoData = person.photo_url || person.photo_base64;
                                if (photoData) {
                                    const photoSrc = photoData.startsWith('data:') ? photoData : `data:image/jpeg;base64,${photoData}`;
                                    return `<img src="${photoSrc}" 
                                                style="width: 150px; height: 150px; border-radius: 8px; object-fit: cover;">`;
                                } else {
                                    return `<div style="width: 150px; height: 150px; background: #f3f4f6; border-radius: 8px; 
                                                        display: flex; align-items: center; justify-content: center;">
                                                <span style="font-size: 3rem;">ğŸ‘¤</span>
                                            </div>`;
                                }
                            })()}
                        </div>
                        <div style="flex: 1;">
                            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;">
                                ${person.name || 'ì´ë¦„ ë¯¸ìƒ'}
                            </h2>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <div><strong>ë‚˜ì´:</strong> ${person.age || 'ë¯¸ìƒ'}ì„¸</div>
                                <div><strong>ì„±ë³„:</strong> ${person.gender || 'ë¯¸ìƒ'}</div>
                                <div><strong>ë¶„ë¥˜:</strong> ${person.category || 'ê¸°íƒ€'}</div>
                                <div><strong>ìš°ì„ ìˆœìœ„:</strong> <span style="color: ${person.priority === 'HIGH' ? '#ef4444' : '#f59e0b'}">${person.priority}</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.5rem;">ì‹¤ì¢… ì¥ì†Œ</h4>
                        <p>${person.location || 'ì •ë³´ ì—†ìŒ'}</p>
                    </div>
                    
                    ${person.description ? `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.5rem;">ìƒì„¸ ì„¤ëª…</h4>
                        <p style="white-space: pre-line;">${person.description}</p>
                    </div>
                    ` : ''}
                    
                    ${person.extracted_features && person.extracted_features['ì¶”ê°€ì •ë³´'] ? `
                    <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; border: 2px solid #3b82f6; margin-bottom: 1rem;">
                        <h4 style="color: #1e40af; font-weight: 600; margin-bottom: 0.5rem;">ğŸ“‹ ìƒì„¸ ì¶”ê°€ ì •ë³´</h4>
                        <ul style="margin: 0; padding-left: 1.5rem;">
                            ${person.extracted_features['ì¶”ê°€ì •ë³´'].map(info => 
                                `<li style="margin-bottom: 0.5rem; line-height: 1.5;">${info}</li>`
                            ).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    ${person.extracted_features ? (() => {
                        const features = person.extracted_features;
                        const featureCategories = {
                            'basic_info': { title: 'ê¸°ë³¸ ì •ë³´', color: '#dbeafe', icon: 'ğŸ‘¤' },
                            'appearance': { title: 'ì™¸ëª¨ íŠ¹ì§•', color: '#fef3c7', icon: 'ğŸ‘ï¸' },
                            'clothing': { title: 'ì˜ë³µ', color: '#e0e7ff', icon: 'ğŸ‘•' },
                            'behavior': { title: 'í–‰ë™ íŠ¹ì„±', color: '#fce7f3', icon: 'ğŸš¶' },
                            'health': { title: 'ê±´ê°• ìƒíƒœ', color: '#fee2e2', icon: 'ğŸ’Š' },
                            'items': { title: 'ì†Œì§€í’ˆ', color: '#d1fae5', icon: 'ğŸ’' },
                            'transport': { title: 'ì´ë™ìˆ˜ë‹¨', color: '#cffafe', icon: 'ğŸš—' },
                            'additional': { title: 'ê¸°íƒ€ ì •ë³´', color: '#f3f4f6', icon: 'â„¹ï¸' }
                        };
                        
                        let html = '';
                        for (const [key, value] of Object.entries(features)) {
                            if (key === 'ì¶”ê°€ì •ë³´' || !value || value.length === 0) continue;
                            
                            const category = featureCategories[key];
                            if (!category) continue;
                            
                            html += `
                            <div style="background: ${category.color}; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem;">
                                <h5 style="font-weight: 600; margin-bottom: 0.25rem; font-size: 0.9rem;">
                                    ${category.icon} ${category.title}
                                </h5>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                    ${value.map(item => 
                                        `<span style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">${item}</span>`
                                    ).join('')}
                                </div>
                            </div>`;
                        }
                        return html;
                    })() : ''}
                    
                    ${person.risk_factors && person.risk_factors.length > 0 ? `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.5rem;">ìœ„í—˜ ìš”ì†Œ</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${person.risk_factors.map(factor => 
                                `<span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; 
                                            border-radius: 16px; font-size: 0.75rem;">${factor}</span>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;
                
                // ëª¨ë‹¬ í‘œì‹œ
                modal.style.display = 'flex';
                console.log('ëª¨ë‹¬ í‘œì‹œë¨');  // ë””ë²„ê¹…ìš©
                
            } catch (error) {
                console.error('ìƒì„¸ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                admin.showToast('ì‹¤ì¢…ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        class AdminDashboard {
            constructor() {
                this.ws = null;
                this.persons = [];
                this.drivers = [];
                this.selectedPerson = null;
                this.selectedDriver = null;
                this.isConnected = false;
                this.map = null;
                this.geocoder = null;
                this.markers = [];
                this.driverMarkers = [];
                this.heatmapCircles = [];
                this.cctvMarkers = []; 
                this.allCCTVs = [];     
                this.showCCTVMarkers = true;
                this.showHeatmap = true;
                this.showDrivers = true;
                this.heatmapOpacity = 0.15;
                this.personVisibility = {};
                this.movementPredictions = [];
                this.movementOverlays = [];
                
                this.SEARCH_RADIUS_BY_CATEGORY = {
                    'ë¯¸ì·¨í•™ì•„ë™': 1600,      // ISRID: 1~6ì„¸
                    'ì´ˆë“±ì €í•™ë…„': 2500,      // ISRID: 7~9ì„¸ (2~3km)
                    'ì´ˆë“±ê³ í•™ë…„': 4000,      // ISRID: 10~12ì„¸ (3~5km)
                    'ì¤‘ê³ ë“±í•™ìƒ': 6500,      // ISRID: 13~18ì„¸ (5~8km)
                    'ì¹˜ë§¤í™˜ì': 3840,        // ê²½ì°°ì²­ ì—°êµ¬: ë¶€ì‚° ì§€ì—­ ì‹¤ì¦ ë°ì´í„°
                    'ê³ ë ¹ì': 5000,          // 65ì„¸ ì´ìƒ ì¼ë°˜
                    'ì§€ì ì¥ì• ì¸': 2000,      // ISRID
                    'ìíì¥ì• ì¸': 1800,      // ISRID
                    'ì„±ì¸ê°€ì¶œ': 8000,        // ISRID + í•œêµ­ ê²½ì°°ì²­
                    'ê¸°íƒ€': 3000
                };

                this.SEARCH_DESCRIPTIONS = {
                    'ë¯¸ì·¨í•™ì•„ë™': 'ISRID ë°ì´í„°: 1~6ì„¸ ì•„ë™ì˜ 50% ì´ìƒì´ 1.6km ì´ë‚´ì—ì„œ ë°œê²¬. ìˆ¨ì–´ì„œ ì ìëŠ” ê²½í–¥. ê³¨ë“ íƒ€ì„: 3ì‹œê°„',
                    'ì´ˆë“±ì €í•™ë…„': 'ISRID ë°ì´í„°: 7~9ì„¸ ì•„ë™ì€ í‰ê·  2~3km ì´ë™. í˜¸ê¸°ì‹¬ìœ¼ë¡œ íƒí—˜í•˜ë‹¤ ê¸¸ì„ ìƒëŠ” ê²½ìš° ë§ìŒ. ê³¨ë“ íƒ€ì„: 24ì‹œê°„',
                    'ì´ˆë“±ê³ í•™ë…„': 'ISRID ë°ì´í„°: 10~12ì„¸ëŠ” í‰ê·  3~5km ì´ë™. ëª¨í—˜ì‹¬ ê°•í•˜ë©° ê²°ì • ì§€ì ì—ì„œ ì˜ëª»ëœ ì„ íƒ. ê³¨ë“ íƒ€ì„: 48ì‹œê°„',
                    'ì¤‘ê³ ë“±í•™ìƒ': 'ISRID ë°ì´í„°: 13~18ì„¸ëŠ” í‰ê·  5~8km ì´ë™. ì˜ë„ì  ê°€ì¶œê³¼ ì‚¬ê³ ì„± ì‹¤ì¢… í˜¼ì¬. ê³¨ë“ íƒ€ì„: 48ì‹œê°„',
                    'ì¹˜ë§¤í™˜ì': 'ê²½ì°°ì²­ ì—°êµ¬ (2018-2021, n=37,619): ë¶€ì‚° ì§€ì—­ í‰ê·  ë°œê²¬ ê±°ë¦¬ 3.84km. ì§ì„  ì´ë™ í›„ ì¥ì• ë¬¼ì— ë©ˆì¶¤. ê³¨ë“ íƒ€ì„: 24-72ì‹œê°„',
                    'ê³ ë ¹ì': '65ì„¸ ì´ìƒ ì¼ë°˜ ë…¸ì¸. ì¹˜ë§¤ í™˜ìë³´ë‹¤ ì´ë™ ê±°ë¦¬ ê¸¸ì§€ë§Œ ì²´ë ¥ ì œí•œ. ê³¨ë“ íƒ€ì„: 48ì‹œê°„',
                    'ì§€ì ì¥ì• ì¸': 'ISRID ë°ì´í„°: ì œí•œì  ì´ë™ ëŠ¥ë ¥, ë°©í–¥ ê°ê° ë¶€ì¡±. ê³¨ë“ íƒ€ì„: 48-72ì‹œê°„',
                    'ìíì¥ì• ì¸': 'ISRID ë°ì´í„°: ìˆ˜ìƒ‰ëŒ€ í˜¸ì¶œì— ì‘ë‹µ ì—†ìŒ, ë¬¼ì— ëŒë¦¬ëŠ” ê²½í–¥. ê³¨ë“ íƒ€ì„: 48-72ì‹œê°„',
                    'ì„±ì¸ê°€ì¶œ': 'ISRID ë°ì´í„°: ì˜ë„ì  ì´ë™ìœ¼ë¡œ í‰ê·  8km ì´ìƒ. êµí†µìˆ˜ë‹¨ ì´ìš© ì‹œ ë²”ìœ„ í™•ì¥. ê³¨ë“ íƒ€ì„: 24ì‹œê°„',
                    'ê¸°íƒ€': 'í‰ê· ì ì¸ ìˆ˜ìƒ‰ ë²”ìœ„ë¥¼ ì ìš©í•©ë‹ˆë‹¤.'
                };

                this.DAEJEON_LOCATIONS = [
                    { name: 'ëŒ€ì „ì—­', lat: 36.3315, lng: 127.4350 },
                    { name: 'ì„œëŒ€ì „ì—­', lat: 36.3255, lng: 127.3770 },
                    { name: 'ìœ ì„±ì˜¨ì²œ', lat: 36.3542, lng: 127.3440 },
                    { name: 'ë‘”ì‚°ë™', lat: 36.3504, lng: 127.3780 },
                    { name: 'íƒ„ë°©ë™', lat: 36.3370, lng: 127.3870 },
                    { name: 'ì€í–‰ë™', lat: 36.3275, lng: 127.4265 },
                    { name: 'KAIST', lat: 36.3736, lng: 127.3650 },
                    { name: 'ì—‘ìŠ¤í¬', lat: 36.3797, lng: 127.3847 },
                    { name: 'í•œë°­ìˆ˜ëª©ì›', lat: 36.3678, lng: 127.3895 },
                    { name: 'ì •ë¶€ì²­ì‚¬', lat: 36.3798, lng: 127.3658 },
                    { name: 'ê°¤ëŸ¬ë¦¬ì•„', lat: 36.3534, lng: 127.3782 },
                    { name: 'ëŒ€ì „ë³µí•©í„°ë¯¸ë„', lat: 36.3349, lng: 127.4344 },
                    { name: 'ì¤‘êµ¬ì²­', lat: 36.3260, lng: 127.4210 },
                    { name: 'ì„œêµ¬ì²­', lat: 36.3553, lng: 127.3837 },
                    { name: 'ë™êµ¬ì²­', lat: 36.3110, lng: 127.4540 },
                    { name: 'ìœ ì„±êµ¬ì²­', lat: 36.3624, lng: 127.3567 },
                    { name: 'ëŒ€ë•êµ¬ì²­', lat: 36.3469, lng: 127.4166 },
                    { name: 'ë³´ë¬¸ì‚°', lat: 36.3400, lng: 127.4100 },
                    { name: 'ëŒ€ì²­í˜¸', lat: 36.4800, lng: 127.4900 },
                    { name: 'ì›”í‰ê³µì›', lat: 36.3490, lng: 127.3620 }
                ];
                
                this.initWebSocket();
                this.initEventListeners();
                this.loadInitialData();
                this.checkKakaoMapAPI();
                this.startDriverSimulation();
                this.checkServerStatus();
                
                setInterval(() => this.updateStats(), 30000);
                setInterval(() => this.updateDriverPositions(), 3000);
                setInterval(() => this.updateDriverStatus(), 10000);
                setInterval(() => this.checkServerStatus(), 60000);
            }

            checkKakaoMapAPI() {
                if (typeof kakao === 'undefined' || !kakao.maps) {
                    document.getElementById('apiKeySetup').innerHTML = `
                        <h3>ì¹´ì¹´ì˜¤ë§µ API ì˜¤ë¥˜</h3>
                        <p>ì¹´ì¹´ì˜¤ë§µ APIë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p><code>.env</code> íŒŒì¼ì— <code>KAKAO_JAVASCRIPT_KEY</code>ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</p>
                    `;
                    this.showToast('ì¹´ì¹´ì˜¤ë§µ API í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”', 'error');
                    return;
                }
                
                setTimeout(() => {
                    this.initializeKakaoMap();
                }, 1000);
            }

            getSearchRadius(person) {
                let category = person.category;
                
                if (!category || category === 'null' || category === 'ê¸°íƒ€') {
                    if (person.age) {
                        if (person.age <= 6) category = 'ë¯¸ì·¨í•™ì•„ë™';
                        else if (person.age <= 9) category = 'ì´ˆë“±ì €í•™ë…„';
                        else if (person.age <= 12) category = 'ì´ˆë“±ê³ í•™ë…„';
                        else if (person.age <= 18) category = 'ì¤‘ê³ ë“±í•™ìƒ';
                        else if (person.age >= 65) {
                            // medical_condition í™•ì¸
                            if (person.medical_condition && 
                                (person.medical_condition.includes('ì¹˜ë§¤') || 
                                person.medical_condition.includes('dementia') ||
                                person.medical_condition.includes('ì•Œì¸ í•˜ì´ë¨¸'))) {
                                category = 'ì¹˜ë§¤í™˜ì';
                            } else {
                                category = 'ê³ ë ¹ì';
                            }
                        } else {
                            category = 'ì„±ì¸ê°€ì¶œ';
                        }
                    } else {
                        category = 'ê¸°íƒ€';
                    }
                }
                
                return this.SEARCH_RADIUS_BY_CATEGORY[category] || this.SEARCH_RADIUS_BY_CATEGORY['ê¸°íƒ€'];
            }

            getSearchDescription(person) {
                let category = person.category;
                
                if (!category || category === 'null' || category === 'ê¸°íƒ€') {
                    if (person.age) {
                        if (person.age <= 6) {
                            category = 'ë¯¸ì·¨í•™ì•„ë™';
                        } else if (person.age <= 9) {
                            category = 'ì´ˆë“±ì €í•™ë…„';
                        } else if (person.age <= 12) {
                            category = 'ì´ˆë“±ê³ í•™ë…„';
                        } else if (person.age <= 18) {
                            category = 'ì¤‘ê³ ë“±í•™ìƒ';
                        } else if (person.age >= 65) {
                            if (person.medical_condition && 
                                (person.medical_condition.includes('ì¹˜ë§¤') || 
                                person.medical_condition.includes('dementia') ||
                                person.medical_condition.includes('ì•Œì¸ í•˜ì´ë¨¸'))) {
                                category = 'ì¹˜ë§¤í™˜ì';
                            } else {
                                category = 'ê³ ë ¹ì';
                            }
                        } else {
                            category = 'ì„±ì¸ê°€ì¶œ';
                        }
                    } else {
                        category = 'ê¸°íƒ€';
                    }
                }
                
                return this.SEARCH_DESCRIPTIONS[category] || this.SEARCH_DESCRIPTIONS['ê¸°íƒ€'];
            }

            async getPredictionFromAI(person, lat, lng) {
                try {
                    console.log('í™˜ê²½ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...');
                    
                    // 1. ë¨¼ì € í™˜ê²½ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const envResponse = await fetch('http://localhost:8001/api/get_environment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lat: lat, lon: lng })
                    });
                    
                    let environment = {
                        north: {road_type: "ì´ì°¨ë¡œ", land_use: "ì£¼ê±°ì§€ì—­", poi: ["ì—†ìŒ"], hazard: ["ì—†ìŒ"], slope: "í‰ì§€"},
                        east: {road_type: "ì´ì°¨ë¡œ", land_use: "ì£¼ê±°ì§€ì—­", poi: ["ì—†ìŒ"], hazard: ["ì—†ìŒ"], slope: "í‰ì§€"},
                        south: {road_type: "ì´ì°¨ë¡œ", land_use: "ì£¼ê±°ì§€ì—­", poi: ["ì—†ìŒ"], hazard: ["ì—†ìŒ"], slope: "í‰ì§€"},
                        west: {road_type: "ì´ì°¨ë¡œ", land_use: "ì£¼ê±°ì§€ì—­", poi: ["ì—†ìŒ"], hazard: ["ì—†ìŒ"], slope: "í‰ì§€"}
                    };
                    
                    if (envResponse.ok) {
                        const envData = await envResponse.json();
                        if (envData.success) {
                            environment = envData.environment;
                            console.log('âœ… ì‹¤ì œ í™˜ê²½ ë°ì´í„°:', environment);
                        }
                    } else {
                        console.log('í™˜ê²½ ë°ì´í„° ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©');
                    }
                    
                    // 2. AI ì˜ˆì¸¡ ìš”ì²­
                    console.log('AI ì˜ˆì¸¡ ìš”ì²­ ì¤‘...');
                    const response = await fetch('http://localhost:8002/api/predict_movement', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            person: {
                                category: person.category || 'ê¸°íƒ€',
                                age: person.age || 30,
                                sex: person.gender === 'ë‚¨' ? 'M' : (person.gender === 'ì—¬' ? 'F' : 'M'),
                                time_of_day: 'ë‚®',
                                time_since_missing_hour: 2.0,
                                walking_ability: 'ë³´í†µ'
                            },
                            environment: environment,  // ì‹¤ì œ í™˜ê²½ ë°ì´í„° ì‚¬ìš©
                            lat: lat,
                            lon: lng
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            console.log('AI ì˜ˆì¸¡ ì„±ê³µ:', data.prediction);
                            return data.prediction;
                        }
                    }
                    console.log('AI ì˜ˆì¸¡ ì‹¤íŒ¨');
                    return null;
                    
                } catch (error) {
                    console.error('AI ì˜ˆì¸¡ ì˜¤ë¥˜:', error);
                    return null;
                }
            }
            
            clearMovementArrows() {
                this.movementOverlays.forEach(overlay => overlay.setMap(null));
                this.movementOverlays = [];
            }
            
            async drawMovementArrows(person, lat, lng) {
                this.clearMovementArrows();
                
                if (!this.map || !lat || !lng) return;
                
                console.log('ğŸ¯ í™”ì‚´í‘œ ê·¸ë¦¬ê¸°:', person.name, lat, lng);
                
                const prediction = await this.getPredictionFromAI(person, lat, lng);
                
                if (!prediction) {
                    console.log('âŒ ì˜ˆì¸¡ ë°ì´í„° ì—†ìŒ');
                    return;
                }
                
                const directions = {
                    'north': { angle: 0, offsetLat: 0.005, offsetLng: 0 },
                    'east': { angle: 90, offsetLat: 0, offsetLng: 0.005 },
                    'south': { angle: 180, offsetLat: -0.005, offsetLng: 0 },
                    'west': { angle: 270, offsetLat: 0, offsetLng: -0.005 }
                };
                
                const directionNames = {
                    'north': 'ë¶ìª½',
                    'east': 'ë™ìª½',
                    'south': 'ë‚¨ìª½',
                    'west': 'ì„œìª½'
                };
                
                if (this.movementOverlays && this.movementOverlays.length > 0) {
                    this.movementOverlays.forEach(overlay => overlay.setMap(null));
                    this.movementOverlays = [];
                }

                Object.entries(prediction).forEach(([direction, data]) => {
                    const dir = directions[direction];
                    if (!dir) return;
                    
                    const arrowLat = lat + dir.offsetLat;
                    const arrowLng = lng + dir.offsetLng;
                    const position = new kakao.maps.LatLng(arrowLat, arrowLng);
                    
                    const probability = data.prob;
                    const reason = data.reason;
                    
                    const arrowSize = 40 + (probability / 100) * 20;
                    const arrowColor = probability >= 30 ? '#ef4444' : probability >= 20 ? '#f59e0b' : '#3b82f6';
                    
                    const content = document.createElement('div');
                    content.style.cssText = 'position: relative; cursor: pointer; transform-origin: center;';
                    
                    content.innerHTML = `
                        <div class="movement-arrow" style="width: ${arrowSize}px; height: ${arrowSize}px; position: relative; transform: rotate(${dir.angle}deg); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                            <svg width="${arrowSize}" height="${arrowSize}" viewBox="0 0 40 40">
                                <defs>
                                    <marker id="arrowhead-${direction}" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                        <polygon points="0 0, 10 3, 0 6" fill="${arrowColor}" />
                                    </marker>
                                </defs>
                                <line x1="20" y1="35" x2="20" y2="10" stroke="${arrowColor}" stroke-width="3" marker-end="url(#arrowhead-${direction})" />
                                <circle cx="20" cy="35" r="3" fill="${arrowColor}" />
                            </svg>
                            <div style="position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%) rotate(-${dir.angle}deg); background: ${arrowColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                ${probability}%
                            </div>
                        </div>
                        <div class="movement-popup" style="
                            display: none; 
                            position: absolute; 
                            bottom: ${arrowSize + 30}px; 
                            left: 50%; 
                            transform: translateX(-50%); 
                            background: white; 
                            padding: 10px 14px; 
                            border-radius: 8px; 
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
                            border: 2px solid ${arrowColor}; 
                            width: 280px; 
                            z-index: 1000; 
                            white-space: normal; 
                            word-wrap: break-word; 
                            overflow-wrap: break-word; 
                            overflow: hidden; 
                            box-sizing: border-box;">
                            <div style="
                                font-weight: bold; 
                                color: #1e293b; 
                                margin-bottom: 4px; 
                                font-size: 13px;
                                white-space: normal;
                                word-wrap: break-word;">
                                ${directionNames[direction]} ë°©í–¥
                            </div>
                            <div style="
                                color: #64748b; 
                                font-size: 12px; 
                                line-height: 1.4;
                                white-space: normal;
                                word-wrap: break-word;
                                overflow-wrap: break-word;">
                                ${reason}
                            </div>
                            <div style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 8px solid ${arrowColor};"></div>
                        </div>
                    `;
                    
                    const arrow = content.querySelector('.movement-arrow');
                    const popup = content.querySelector('.movement-popup');
                    
                    arrow.addEventListener('mouseenter', () => {
                        popup.style.display = 'block';
                    });
                    
                    arrow.addEventListener('mouseleave', () => {
                        popup.style.display = 'none';
                    });
                    
                    const overlay = new kakao.maps.CustomOverlay({
                        position: position,
                        content: content,
                        yAnchor: 0.5,
                        xAnchor: 0.5
                    });
                    
                    overlay.setMap(this.map);
                    this.movementOverlays.push(overlay);
                });
                
                console.log(`âœ… í™”ì‚´í‘œ ${this.movementOverlays.length}ê°œ í‘œì‹œë¨`);
            }

            isWaterArea(lat, lng) {
                if (lat >= 36.32 && lat <= 36.38 && lng >= 127.35 && lng <= 127.40) {
                    if (Math.abs(lng - 127.375) < 0.005) return true;
                }
                
                if (lat >= 36.32 && lat <= 36.35 && lng >= 127.42 && lng <= 127.44) {
                    if (Math.abs(lng - 127.43) < 0.003) return true;
                }
                
                if (lat >= 36.35 && lat <= 36.37 && lng >= 127.41 && lng <= 127.43) {
                    if (Math.abs(lat - 36.36) < 0.003) return true;
                }
                
                if (lat >= 36.48) return true;
                
                if (lat >= 36.45 && lng <= 127.30) return true;
                
                return false;
            }

            isValidPosition(lat, lng) {
                if (lat < 36.20 || lat > 36.50 || lng < 127.20 || lng > 127.60) {
                    return false;
                }
                
                if (this.isWaterArea(lat, lng)) {
                    return false;
                }
                
                return true;
            }

            async checkServerStatus() {
                try {
                    const response = await fetch('http://localhost:8001/api/health');
                    if (response.ok) {
                        console.log('âœ… ë©”ì¸ ì„œë²„ ì •ìƒ');
                    }
                } catch (error) {
                    console.error('ë©”ì¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨:', error);
                }
            }

            updateServerIndicator(elementId, isOnline) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.className = `server-indicator ${isOnline ? 'online' : 'offline'}`;
                }
            }
            
            async initializeKakaoMap() {  // async ì¶”ê°€
                if (typeof kakao === 'undefined' || !kakao.maps) {
                    this.showToast('ì¹´ì¹´ì˜¤ë§µ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                try {
                    const mapContainer = document.getElementById('map');
                    const mapOption = {
                        center: new kakao.maps.LatLng(36.3504, 127.3845),
                        level: 5
                    };

                    this.map = new kakao.maps.Map(mapContainer, mapOption);
                    this.geocoder = new kakao.maps.services.Geocoder();

                    document.getElementById('apiKeySetup').style.display = 'none';
                    document.getElementById('map').style.display = 'block';
                    document.getElementById('mapOverlay').style.display = 'flex';
                    document.getElementById('mapStatus').className = 'status-indicator';
                    
                    setTimeout(() => {
                        this.map.relayout();
                        this.updateMapMarkers();
                    }, 500);
                    
                    this.addActivity({
                        time: new Date().toLocaleTimeString(),
                        content: 'ì¹´ì¹´ì˜¤ë§µì´ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'
                    });
                    
                    this.showToast('ì¹´ì¹´ì˜¤ë§µì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    
                    await this.loadAllCCTVs();
                    
                } catch (error) {
                    this.showToast('ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message, 'error');
                }
            }

            toggleAllPersons(visible) {
                this.persons.forEach(person => {
                    this.personVisibility[person.id] = visible;
                });
                this.renderPersonList();
                setTimeout(() => {
                    this.updateMapMarkers();
                }, 100);
            }

            togglePersonVisibility(personId, visible) {
                this.personVisibility[personId] = visible;
                setTimeout(() => {
                    this.updateMapMarkers();
                }, 100);
            }

            async updateMapMarkers() {
                if (!this.map) return;
                
                this.clearMovementArrows();
                this.clearMarkers();
                this.clearHeatmap();
                
                const visiblePersons = this.persons.filter(p => this.personVisibility[p.id] !== false);
                
                let markersCreated = 0;
                
                for (const person of visiblePersons) {
                    if (person.lat && person.lng && person.lat !== 36.5 && person.lng !== 127.8) {
                        this.createMarker(person, person.lat, person.lng);
                        this.addHeatmapForPerson(person, person.lat, person.lng);
                        markersCreated++;
                    } else if (person.location && this.geocoder) {
                        try {
                            await this.addMarkerWithGeocoding(person);
                            markersCreated++;
                        } catch (error) {
                            console.log(`ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨ (${person.name}): ${error}`);
                        }
                    }
                }
                
                if (this.showDrivers) {
                    this.updateDriverMarkers();
                }
                
                document.getElementById('markerCount').textContent = `ë§ˆì»¤: ${markersCreated}ê°œ`;
                document.getElementById('driverCount').textContent = `ì˜¨ë¼ì¸ ê¸°ì‚¬: ${this.drivers.filter(d => d.status === 'online').length}ëª…`;
            }

            clearHeatmap() {
                this.heatmapCircles.forEach(circle => circle.setMap(null));
                this.heatmapCircles = [];
            }

            addHeatmapForPerson(person, lat, lng) {
                if (!this.showHeatmap) return;
                
                const radius = this.getSearchRadius(person);
                const position = new kakao.maps.LatLng(lat, lng);
                
                const innerCircle = new kakao.maps.Circle({
                    center: position,
                    radius: radius * 0.6,
                    strokeWeight: 2,
                    strokeColor: '#FF4444',
                    strokeOpacity: this.heatmapOpacity * 0.8,
                    fillColor: '#FF4444',
                    fillOpacity: this.heatmapOpacity * 0.5
                });
                
                const outerCircle = new kakao.maps.Circle({
                    center: position,
                    radius: radius,
                    strokeWeight: 2,
                    strokeColor: '#FF8800',
                    strokeOpacity: this.heatmapOpacity * 0.6,
                    fillColor: '#FF8800',
                    fillOpacity: this.heatmapOpacity * 0.3
                });
                
                innerCircle.setMap(this.map);
                outerCircle.setMap(this.map);
                
                this.heatmapCircles.push(innerCircle, outerCircle);
            }

            updateHeatmapOpacity() {
                const rawValue = parseFloat(document.getElementById('heatmapOpacity').value);
                this.heatmapOpacity = rawValue;
                const displayValue = Math.round(rawValue * 100);
                document.getElementById('opacityValue').textContent = displayValue + '%';
                
                if (this.showHeatmap) {
                    this.clearHeatmap();
                    
                    this.persons.forEach((person) => {
                        if (this.personVisibility[person.id] !== false && person.lat && person.lng) {
                            this.addHeatmapForPerson(person, person.lat, person.lng);
                        }
                    });
                }
            }

            toggleHeatmap() {
                this.showHeatmap = document.getElementById('showHeatmap').checked;
                this.updateMapMarkers();
            }

            toggleDriverVisibility() {
                this.showDrivers = document.getElementById('showDrivers').checked;
                if (this.showDrivers) {
                    this.updateDriverMarkers();
                } else {
                    this.driverMarkers.forEach(marker => marker.setMap(null));
                    this.driverMarkers = [];
                }
                document.getElementById('driverCount').textContent = `ì˜¨ë¼ì¸ ê¸°ì‚¬: ${this.drivers.filter(d => d.status === 'online').length}ëª…`;
            }

            async addMarkerWithGeocoding(person) {
                return new Promise((resolve, reject) => {
                    this.geocoder.addressSearch(person.location, (result, status) => {
                        if (status === kakao.maps.services.Status.OK) {
                            const lat = parseFloat(result[0].y);
                            const lng = parseFloat(result[0].x);
                            
                            person.lat = lat;
                            person.lng = lng;
                            
                            this.createMarker(person, lat, lng);
                            this.addHeatmapForPerson(person, lat, lng);
                            resolve();
                        } else {
                            reject(new Error(`ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨: ${status}`));
                        }
                    });
                });
            }
            
            clearMarkers() {
                this.markers.forEach(marker => marker.setMap(null));
                this.markers = [];
            }
            
            createMarker(person, lat, lng) {
                const position = new kakao.maps.LatLng(lat, lng);
                
                const marker = new kakao.maps.Marker({
                    position: position,
                    map: this.map
                });

                const radius = this.getSearchRadius(person);
                const description = this.getSearchDescription(person);
                
                let displayCategory = person.category;
                if (!displayCategory || displayCategory === 'null' || displayCategory === 'ê¸°íƒ€') {
                    if (person.age) {
                        if (person.age <= 6) displayCategory = 'ë¯¸ì·¨í•™ì•„ë™';
                        else if (person.age <= 9) displayCategory = 'ì´ˆë“±ì €í•™ë…„';
                        else if (person.age <= 12) displayCategory = 'ì´ˆë“±ê³ í•™ë…„';
                        else if (person.age <= 18) displayCategory = 'ì¤‘ê³ ë“±í•™ìƒ';
                        else if (person.age >= 65) displayCategory = 'ê³ ë ¹ì';
                        else displayCategory = 'ì„±ì¸';
                    } else {
                        displayCategory = 'ê¸°íƒ€';
                    }
                }

                const infoContent = `
                    <div style="padding:15px; min-width:300px;">
                        <h4 style="margin:0 0 10px 0; color:#2c3e50;">${person.name || 'ì´ë¦„ ë¯¸ìƒ'}</h4>
                        <div style="font-size:14px; color:#555; line-height:1.6;">
                            <div><strong>ë‚˜ì´:</strong> ${person.age || 'ë¯¸ìƒ'}ì„¸ | <strong>ë¶„ë¥˜:</strong> ${displayCategory}</div>
                            <div><strong>ìš°ì„ ìˆœìœ„:</strong> ${person.priority || 'MEDIUM'}</div>
                            <div><strong>ì‹¤ì¢…ì¥ì†Œ:</strong> ${person.location || 'ë¯¸ìƒ'}</div>
                            <div style="background:#f0f9ff; padding:8px; border-radius:4px; margin:8px 0;">
                                <strong>ìˆ˜ìƒ‰ë²”ìœ„:</strong> ${(radius/1000).toFixed(1)}km<br>
                                <small style="color:#1e40af;">${description}</small>
                            </div>
                        </div>
                    </div>
                `;

                const infoWindow = new kakao.maps.InfoWindow({
                    content: infoContent,
                    removable: true
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                    infoWindow.open(this.map, marker);
                    this.selectPerson(person.id);
                });

                this.markers.push(marker);
            }
            
            updateDriverMarkers() {
                if (!this.map || !this.showDrivers) return;
                
                this.driverMarkers.forEach(marker => marker.setMap(null));
                this.driverMarkers = [];
                
                const onlineDrivers = this.drivers.filter(driver => driver.status === 'online');
                const displayDrivers = onlineDrivers.slice(0, 500);
                
                displayDrivers.forEach(driver => {
                    this.createDriverMarker(driver);
                });
            }

            createDriverMarker(driver) {
                const position = new kakao.maps.LatLng(driver.lat, driver.lng);
                
                const markerImageSrc = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`
                    <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="8" cy="8" r="6" fill="${driver.type === 'taxi' ? '#2563eb' : '#059669'}" stroke="white" stroke-width="1"/>
                        <text x="8" y="11" text-anchor="middle" fill="white" font-size="8">${driver.type === 'taxi' ? 'T' : 'D'}</text>
                    </svg>
                `)}`;
                
                const markerImageSize = new kakao.maps.Size(16, 16);
                const markerImage = new kakao.maps.MarkerImage(markerImageSrc, markerImageSize);
                
                const marker = new kakao.maps.Marker({
                    position: position,
                    map: this.map,
                    image: markerImage
                });

                const infoContent = `
                    <div style="padding:15px; min-width:200px;">
                        <h4 style="margin:0 0 10px 0; color:#2c3e50;">${driver.name} ê¸°ì‚¬</h4>
                        <div style="font-size:14px; color:#555; line-height:1.6;">
                            <div><strong>ì°¨ëŸ‰ë²ˆí˜¸:</strong> ${driver.vehicle}</div>
                            <div><strong>ì—…ì¢…:</strong> ${this.getDriverTypeName(driver.type)}</div>
                            <div><strong>ì§€ì—­:</strong> ${driver.region}</div>
                            <div><strong>í˜„ì¬ì†ë„:</strong> ${driver.speed === 0 && driver.type === 'delivery' ? 'ë°°ë‹¬ì¤‘ (ì •ì§€)' : Math.round(driver.speed) + 'km/h'}</div>
                            <div><strong>ìƒíƒœ:</strong> <span style="color: #10b981;">${driver.status === 'online' ? 'ìš´í–‰ì¤‘' : 'ì˜¤í”„ë¼ì¸'}</span></div>
                            <div><strong>ì´ë™íŒ¨í„´:</strong> ${driver.type === 'taxi' ? 'ë„ë¡œ ì£¼í–‰' : 'ììœ  ì´ë™'}</div>
                        </div>
                    </div>
                `;

                const infoWindow = new kakao.maps.InfoWindow({
                    content: infoContent,
                    removable: true
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                    infoWindow.open(this.map, marker);
                    this.selectDriver(driver.id);
                });

                this.driverMarkers.push(marker);
            }
            
            getSelectedPerson() {
                if (!this.selectedPerson) return null;
                return this.persons.find(p => p.id === this.selectedPerson);
            }

            startDriverSimulation() {
                const driverTypes = ['taxi', 'delivery'];
                const surnames = ['ê¹€', 'ì´', 'ë°•', 'ìµœ', 'ì •', 'ì¡°', 'ìœ¤', 'ì†¡', 'í•œ', 'í™', 'ê°•', 'í™©', 'ì„', 'ì˜¤', 'ì„œ', 'ì‹ ', 'ê¶Œ', 'ë‚¨', 'ì•ˆ', 'ì „'];
                
                const regions = [
                    { 
                        name: 'ë™êµ¬', 
                        count: 200, 
                        locations: ['ê°€ì–‘', 'ëŒ€ë™', 'ì¤‘ì•™', 'ìì–‘', 'íš¨', 'íŒì•”', 'ìš©ìš´', 'ëŒ€ì²­', 'ì‹ ì¸', 'ì‚¼ì„±', 'íš¨í‰', 'ì‹ ìƒ', 'í™ë„', 'ì„±ë‚¨', 'ì •ë™']
                    },
                    { 
                        name: 'ì¤‘êµ¬', 
                        count: 200, 
                        locations: ['ì€í–‰', 'ì„ í™”', 'ëª©', 'ëŒ€í¥', 'ë¬¸í™”', 'ì„êµ', 'ìœ ì²œ', 'ëŒ€ì‚¬', 'ì¤‘ì´Œ', 'ì˜¥ê³„']
                    },
                    { 
                        name: 'ì„œêµ¬', 
                        count: 200, 
                        locations: ['ë‘”ì‚°', 'íƒ„ë°©', 'ìš©ë¬¸', 'ì›”í‰', 'ë³€', 'ê°ˆë§ˆ', 'ë³µìˆ˜', 'ë„ë§ˆ', 'ê´´ì •', 'ê°€ìˆ˜ì›', 'ë‚´', 'ê´€ì €']
                    },
                    { 
                        name: 'ìœ ì„±êµ¬', 
                        count: 200, 
                        locations: ['ê¶', 'ë´‰ëª…', 'ì‹ ì„±', 'ê´€í‰', 'ë…¸ì€', 'ì „ë¯¼', 'êµ¬ì¦‰', 'ì›ì‹ ', 'ì§€ì¡±', 'ì–´ì€', 'í•™í•˜', 'ì˜¨ì²œ', 'ë•ëª…']
                    },
                    { 
                        name: 'ëŒ€ë•êµ¬', 
                        count: 200, 
                        locations: ['ì˜¤ì •', 'ì¤‘ë¦¬', 'ë²•', 'ì‹ íƒ„ì§„', 'ëŒ€í™”', 'ìë‚´', 'ì„ë´‰', 'ëª©ìƒ', 'íšŒë•', 'ë¹„ë˜', 'ì†¡ì´Œ']
                    }
                ];
                
                let driverIndex = 0;
                
                regions.forEach(region => {
                    for (let i = 0; i < region.count; i++) {
                        const type = driverTypes[Math.floor(Math.random() * driverTypes.length)];
                        const surname = surnames[Math.floor(Math.random() * surnames.length)];
                        const locationName = region.locations[Math.floor(Math.random() * region.locations.length)];
                        const suffix = type === 'taxi' ? 'íƒì‹œ' : 'ë¼ì´ë”';
                        const name = surname + locationName + suffix + (i % 50 + 1);
                        
                        setTimeout(() => {
                            let lat, lng;
                            let attempts = 0;
                            
                            do {
                                const baseLocation = this.DAEJEON_LOCATIONS[Math.floor(Math.random() * this.DAEJEON_LOCATIONS.length)];
                                lat = baseLocation.lat + (Math.random() - 0.5) * 0.08;
                                lng = baseLocation.lng + (Math.random() - 0.5) * 0.08;
                                attempts++;
                            } while (!this.isValidPosition(lat, lng) && attempts < 50);
                            
                            if (this.isValidPosition(lat, lng)) {
                                const newDriver = {
                                    id: 'driver_' + driverIndex++,
                                    name: name,
                                    vehicle: this.generateVehicleNumber('ëŒ€ì „'),
                                    phone: '010-' + String(Math.floor(Math.random() * 10000)).padStart(4, '0') + '-' + String(Math.floor(Math.random() * 10000)).padStart(4, '0'),
                                    type: type,
                                    region: region.name,
                                    lat: lat,
                                    lng: lng,
                                    status: Math.random() > 0.25 ? 'online' : 'offline',
                                    speed: Math.random() * 40 + 20,
                                    heading: type === 'taxi' ? (Math.floor(Math.random() * 4) * 90) : (Math.random() * 360)
                                };
                                
                                this.drivers.push(newDriver);
                                
                                if (driverIndex % 100 === 0) {
                                    console.log(`${driverIndex}ëª… ìƒì„±ë¨`);
                                    this.updateDriverList();
                                    this.updateDriverMarkers();
                                }
                            }
                        }, i * 8);
                    }
                });
                
                console.log('ëŒ€ì „ ì§€ì—­ 1000ëª… ê¸°ì‚¬ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘');
            }

            generateVehicleNumber(region) {
                const areas = {
                    'ì„œìš¸': ['ì„œìš¸'],
                    'ë¶€ì‚°': ['ë¶€ì‚°'],
                    'ëŒ€êµ¬': ['ëŒ€êµ¬'],
                    'ì¸ì²œ': ['ì¸ì²œ'],
                    'ê´‘ì£¼': ['ê´‘ì£¼'],
                    'ëŒ€ì „': ['ëŒ€ì „'],
                    'ìš¸ì‚°': ['ìš¸ì‚°'],
                    'ê²½ê¸°': ['ê²½ê¸°'],
                    'ê°•ì›': ['ê°•ì›'],
                    'ì¶©ë¶': ['ì¶©ë¶'],
                    'ì¶©ë‚¨': ['ì¶©ë‚¨'],
                    'ì „ë¶': ['ì „ë¶'],
                    'ì „ë‚¨': ['ì „ë‚¨'],
                    'ê²½ë¶': ['ê²½ë¶'],
                    'ê²½ë‚¨': ['ê²½ë‚¨'],
                    'ì œì£¼': ['ì œì£¼']
                };
                
                const area = areas[region] ? areas[region][0] : 'ê²½ê¸°';
                const numbers = String(Math.floor(Math.random() * 90) + 10);
                const chars = ['ê°€', 'ë‚˜', 'ë‹¤', 'ë¼', 'ë§ˆ', 'ë°”', 'ì‚¬', 'ì•„', 'ì', 'ì°¨'];
                const char = chars[Math.floor(Math.random() * chars.length)];
                const lastNumbers = String(Math.floor(Math.random() * 9000) + 1000);
                return `${area} ${numbers}${char}${lastNumbers}`;
            }

            updateDriverPositions() {
                this.drivers.forEach(driver => {
                    if (driver.status === 'online') {
                        const moveDistance = (driver.speed / 3600) * 3;
                        const earthRadius = 6371;
                        
                        let newLat, newLng;
                        
                        if (driver.type === 'taxi') {
                            const deltaLat = (moveDistance / earthRadius) * (180 / Math.PI) * Math.cos(driver.heading * Math.PI / 180) * 0.3;
                            const deltaLng = (moveDistance / earthRadius) * (180 / Math.PI) * Math.sin(driver.heading * Math.PI / 180) / Math.cos(driver.lat * Math.PI / 180) * 0.3;
                            
                            newLat = driver.lat + deltaLat;
                            newLng = driver.lng + deltaLng;
                            
                            if (!this.isValidPosition(newLat, newLng)) {
                                const possibleDirections = [0, 90, 180, 270].filter(dir => dir !== driver.heading);
                                driver.heading = possibleDirections[Math.floor(Math.random() * possibleDirections.length)];
                                
                                const retryDeltaLat = (moveDistance / earthRadius) * (180 / Math.PI) * Math.cos(driver.heading * Math.PI / 180) * 0.3;
                                const retryDeltaLng = (moveDistance / earthRadius) * (180 / Math.PI) * Math.sin(driver.heading * Math.PI / 180) / Math.cos(driver.lat * Math.PI / 180) * 0.3;
                                
                                newLat = driver.lat + retryDeltaLat;
                                newLng = driver.lng + retryDeltaLng;
                            }
                            
                            if (this.isValidPosition(newLat, newLng)) {
                                driver.lat = newLat;
                                driver.lng = newLng;
                            }
                            
                            if (Math.random() < 0.03) {
                                const possibleDirections = [0, 90, 180, 270];
                                const currentDirection = Math.round(driver.heading / 90) * 90;
                                const newDirections = possibleDirections.filter(dir => Math.abs(dir - currentDirection) === 90 || Math.abs(dir - currentDirection) === 270);
                                if (newDirections.length > 0) {
                                    driver.heading = newDirections[Math.floor(Math.random() * newDirections.length)];
                                }
                            }
                            
                            driver.speed += (Math.random() - 0.5) * 5;
                            driver.speed = Math.max(15, Math.min(60, driver.speed));
                            
                        } else {
                            const deltaLat = (moveDistance / earthRadius) * (180 / Math.PI) * Math.cos(driver.heading * Math.PI / 180) * 0.8;
                            const deltaLng = (moveDistance / earthRadius) * (180 / Math.PI) * Math.sin(driver.heading * Math.PI / 180) / Math.cos(driver.lat * Math.PI / 180) * 0.8;
                            
                            newLat = driver.lat + deltaLat;
                            newLng = driver.lng + deltaLng;
                            
                            if (!this.isValidPosition(newLat, newLng)) {
                                driver.heading = (driver.heading + 180 + (Math.random() - 0.5) * 90) % 360;
                                if (driver.heading < 0) driver.heading += 360;
                                
                                const retryDeltaLat = (moveDistance / earthRadius) * (180 / Math.PI) * Math.cos(driver.heading * Math.PI / 180) * 0.8;
                                const retryDeltaLng = (moveDistance / earthRadius) * (180 / Math.PI) * Math.sin(driver.heading * Math.PI / 180) / Math.cos(driver.lat * Math.PI / 180) * 0.8;
                                
                                newLat = driver.lat + retryDeltaLat;
                                newLng = driver.lng + retryDeltaLng;
                            }
                            
                            if (this.isValidPosition(newLat, newLng)) {
                                driver.lat = newLat;
                                driver.lng = newLng;
                            }
                            
                            if (Math.random() < 0.08) {
                                driver.heading += (Math.random() - 0.5) * 180;
                                driver.heading = driver.heading % 360;
                                if (driver.heading < 0) driver.heading += 360;
                            }
                            
                            driver.speed += (Math.random() - 0.5) * 15;
                            driver.speed = Math.max(5, Math.min(50, driver.speed));
                            
                            if (Math.random() < 0.01) {
                                driver.speed = 0;
                            } else if (driver.speed === 0 && Math.random() < 0.3) {
                                driver.speed = Math.random() * 20 + 10;
                            }
                        }
                    }
                });
                
                if (this.showDrivers) {
                    this.updateDriverMarkers();
                }
            }

            updateDriverStatus() {
                this.drivers.forEach(driver => {
                    if (Math.random() < 0.03) {
                        driver.status = driver.status === 'online' ? 'offline' : 'online';
                    }
                });
                
                this.updateDriverList();
                this.updateStats();
            }

            updateDriverList() {
                const container = document.getElementById('driverList');
                
                if (!this.drivers.length) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #9ca3af;">ë“±ë¡ëœ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                const onlineDrivers = this.drivers.filter(d => d.status === 'online');
                const displayDrivers = onlineDrivers.slice(0, 50);
                
                const html = displayDrivers.map(driver => {
                    const selectedClass = this.selectedDriver === driver.id ? 'selected' : '';
                    const statusClass = driver.status === 'online' ? 'online' : 'offline';
                    
                    return `
                        <div class="person-item ${selectedClass}" 
                             onclick="admin.selectDriver('${driver.id}')" data-driver-id="${driver.id}">
                            <div class="person-marker" style="background: ${driver.status === 'online' ? '#2563eb' : '#6b7280'}; color: white;">
                                ${driver.type === 'taxi' ? 'T' : 'D'}
                            </div>
                            <div class="person-info">
                                <div class="person-name">
                                    ${driver.name} (${driver.vehicle})
                                    <span class="driver-status ${statusClass}"></span>
                                </div>
                                <div class="person-details">
                                    ${this.getDriverTypeName(driver.type)} | ${driver.speed === 0 && driver.type === 'delivery' ? 'ë°°ë‹¬ì¤‘' : Math.round(driver.speed) + 'km/h'}<br>
                                    ${driver.region} | ìƒíƒœ: ${driver.status === 'online' ? 'ìš´í–‰ì¤‘' : 'ì˜¤í”„ë¼ì¸'} | ${driver.type === 'taxi' ? 'ë„ë¡œì£¼í–‰' : 'ììœ ì´ë™'}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html + (onlineDrivers.length > 50 ? 
                    `<div style="text-align: center; padding: 1rem; color: #9ca3af; font-size: 0.8rem;">
                        ì˜¨ë¼ì¸ ê¸°ì‚¬ ${onlineDrivers.length}ëª… ì¤‘ 50ëª… í‘œì‹œ
                    </div>` : '');
            }

            selectDriver(driverId) {
                this.selectedDriver = driverId;
                this.updateDriverList();
                
                const driver = this.drivers.find(d => d.id === driverId);
                if (driver) {
                    this.showToast(`ì„ íƒë¨: ${driver.name} ê¸°ì‚¬`, 'success');
                    
                    if (this.map) {
                        const coords = new kakao.maps.LatLng(driver.lat, driver.lng);
                        this.map.setCenter(coords);
                        this.map.setLevel(3);
                    }
                }
            }

            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c * 1000;
            }

            async getDriversInRange(personId) {
                const person = this.persons.find(p => p.id === personId);
                if (!person) return Promise.resolve([]);

                const searchRadius = this.getSearchRadius(person);
                let personLat, personLng;
                
                if (person.lat && person.lng) {
                    personLat = person.lat;
                    personLng = person.lng;
                    
                    const driversInRange = this.drivers.filter(driver => {
                        if (driver.status !== 'online') return false;
                        
                        const distance = this.calculateDistance(
                            personLat, personLng,
                            driver.lat, driver.lng
                        );
                        
                        return distance <= searchRadius;
                    });
                    
                    return Promise.resolve(driversInRange);
                }
                
                return new Promise((resolve) => {
                    if (!this.geocoder || !person.location) {
                        resolve([]);
                        return;
                    }

                    this.geocoder.addressSearch(person.location, (result, status) => {
                        if (status === kakao.maps.services.Status.OK) {
                            personLat = parseFloat(result[0].y);
                            personLng = parseFloat(result[0].x);
                            
                            const driversInRange = this.drivers.filter(driver => {
                                if (driver.status !== 'online') return false;
                                
                                const distance = this.calculateDistance(
                                    personLat, personLng,
                                    driver.lat, driver.lng
                                );
                                
                                return distance <= searchRadius;
                            });
                            
                            resolve(driversInRange);
                        } else {
                            resolve([]);
                        }
                    });
                });
            }
            
            initWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//localhost:8001/ws`;
                
                try {
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        console.log('WebSocket ì—°ê²°ë¨');
                        this.isConnected = true;
                        this.updateConnectionStatus();
                        
                        setTimeout(async () => {
                            await this.loadAllCCTVs();
                        }, 2000);
                    };
                    
                    this.ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        this.handleWebSocketMessage(message);
                    };
                    
                    this.ws.onclose = () => {
                        console.log('WebSocket ì—°ê²° ëŠì–´ì§');
                        this.isConnected = false;
                        this.updateConnectionStatus();
                        
                        setTimeout(() => this.initWebSocket(), 5000);
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket ì˜¤ë¥˜:', error);
                    };
                } catch (error) {
                    console.error('WebSocket ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    this.isConnected = false;
                    this.updateConnectionStatus();
                }
            }
            
            updateConnectionStatus() {
                const indicator = document.getElementById('connectionStatus');
                if (this.isConnected) {
                    indicator.classList.remove('disconnected');
                } else {
                    indicator.classList.add('disconnected');
                }
            }
            
            handleWebSocketMessage(message) {
                console.log('ë°›ì€ ë©”ì‹œì§€:', message);
                
                switch (message.type) {
                    case 'new_missing_person':
                        this.handleNewMissingPerson(message.data, message.fcm_result);
                        break;
                    case 'manual_notification_sent':
                        this.handleManualNotification(message.data);
                        break;
                            case 'new_report_pending':
                        this.showToast('ìƒˆë¡œìš´ ì‹¤ì¢…ì ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                        if (document.getElementById('reports-tab').classList.contains('active')) {
                            loadPendingReports();
                        }
                        break;
                    
                    case 'person_approved':
                        this.showToast('ì‹¤ì¢…ì ì‹ ê³ ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        if (document.getElementById('reports-tab').classList.contains('active')) {
                            loadApprovedPersons();
                        }
                        this.loadInitialData();
                        break;
                    
                    case 'person_deleted':
                        this.showToast('ì‹¤ì¢…ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                        this.loadInitialData();
                        break;
                }
            }
            
            handleNewMissingPerson(person, fcmResult) {
                this.persons.unshift(person);
                this.personVisibility[person.id] = true;
                
                if (!person.lat || !person.lng || (person.lat === 36.5 && person.lng === 127.8)) {
                    if (person.location) {
                        person.lat = 36.5;
                        person.lng = 127.8;
                    }
                }
                
                this.renderPersonList();
                this.updatePersonSelect();
                setTimeout(() => {
                    this.updateMapMarkers();
                }, 500);
                
                this.addActivity({
                    time: new Date().toLocaleTimeString(),
                    content: `ìƒˆë¡œìš´ ì‹¤ì¢…ì: ${person.name || 'ì´ë¦„ ë¯¸ìƒ'} (${person.location || 'ìœ„ì¹˜ ë¯¸ìƒ'})`
                });
                
                this.showToast(`ìƒˆë¡œìš´ ì‹¤ì¢…ìê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: ${person.name || 'ì´ë¦„ ë¯¸ìƒ'}`, 'success');
                this.updateStats();
            }
            
            handleManualNotification(data) {
                this.addActivity({
                    time: new Date().toLocaleTimeString(),
                    content: `ìˆ˜ë™ ì•Œë¦¼ ì „ì†¡: ${data.person.name || 'ì´ë¦„ ë¯¸ìƒ'} - ${data.result.success}/${data.result.total}`
                });
            }
            
            async loadInitialData() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/missing_persons`);
                    const data = await response.json();
                    this.persons = data.persons || [];
                    
                    this.persons.forEach(person => {
                        this.personVisibility[person.id] = true;
                        
                        if (!person.lat || !person.lng || (person.lat === 36.5 && person.lng === 127.8)) {
                            if (person.location) {
                                person.lat = 36.5;
                                person.lng = 127.8;
                            }
                        }
                    });
                    
                    this.renderPersonList();
                    this.updatePersonSelect();
                    this.updateStats();
                    
                    setTimeout(async () => {
                        this.updateMapMarkers();
                        await this.loadAllCCTVs();
                    }, 1000);
                    
                } catch (error) {
                    console.error('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.showToast('ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                }
            }
            
            renderPersonList() {
                const container = document.getElementById('personList');
                
                if (!this.persons.length) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #9ca3af;">ë“±ë¡ëœ ì‹¤ì¢…ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                const html = this.persons.map((person, index) => {
                    const isNew = index === 0 && this.persons.length > 1;
                    const priorityClass = person.priority === 'HIGH' ? 'high-priority' : '';
                    const newClass = isNew ? 'new' : '';
                    const selectedClass = this.selectedPerson === person.id ? 'selected' : '';
                    
                    if (!(person.id in this.personVisibility)) {
                        this.personVisibility[person.id] = true;
                    }
                    
                    const riskTags = (person.risk_factors || []).map(factor => 
                        `<span class="risk-tag">${factor}</span>`
                    ).join('');

                    const radius = this.getSearchRadius(person);
                    
                    let displayCategory = person.category;
                    if (!displayCategory || displayCategory === 'null' || displayCategory === 'ê¸°íƒ€') {
                        if (person.age) {
                            if (person.age <= 6) displayCategory = 'ë¯¸ì·¨í•™ì•„ë™';
                            else if (person.age <= 9) displayCategory = 'ì´ˆë“±ì €í•™ë…„';
                            else if (person.age <= 12) displayCategory = 'ì´ˆë“±ê³ í•™ë…„';
                            else if (person.age <= 18) displayCategory = 'ì¤‘ê³ ë“±í•™ìƒ';
                            else if (person.age >= 65) displayCategory = 'ê³ ë ¹ì';
                            else displayCategory = 'ì„±ì¸';
                        } else {
                            displayCategory = 'ê¸°íƒ€';
                        }
                    }
                    
                    return `
                        <div class="person-item ${priorityClass} ${newClass} ${selectedClass}" 
                            onclick="admin.selectPerson('${person.id}')" 
                            data-person-id="${person.id}">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-right: 0.5rem;">
                                <input type="checkbox" 
                                    ${this.personVisibility[person.id] ? 'checked' : ''} 
                                    onchange="admin.togglePersonVisibility('${person.id}', this.checked)"
                                    onclick="event.stopPropagation()"
                                    style="margin: 0;">
                                <div class="person-marker ${(person.priority || 'medium').toLowerCase()}">
                                    !
                                </div>
                            </div>
                            <div class="person-info" ondblclick="event.stopPropagation(); showPersonDetail('${person.id}');">
                                <div class="person-name">
                                    ${person.name || 'ì´ë¦„ ë¯¸ìƒ'} (${person.age || 'ë‚˜ì´ ë¯¸ìƒ'}ì„¸)
                                </div>
                                <div class="person-details">
                                    ${person.location || 'ìœ„ì¹˜ ë¯¸ìƒ'}<br>
                                    ${displayCategory} | ìˆ˜ìƒ‰ë²”ìœ„: ${(radius/1000).toFixed(1)}km
                                </div>
                                ${riskTags ? `<div class="risk-tags">${riskTags}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
                
                if (this.persons.length > 0) {
                    setTimeout(() => {
                        const firstItem = container.querySelector('.new');
                        if (firstItem) {
                            firstItem.classList.remove('new');
                        }
                    }, 3000);
                }
            }

            async selectPerson(personId) {
                this.selectedPerson = personId;
                
                // í˜„ì¬ ê²€ìƒ‰ì–´ ì €ì¥
                const searchInput = document.getElementById('missingPersonSearch');
                const currentSearch = searchInput ? searchInput.value : '';
                
                this.renderPersonList();
                this.updatePersonSelect();
                
                // ê²€ìƒ‰ í•„í„° ë‹¤ì‹œ ì ìš©
                if (currentSearch) {
                    searchInput.value = currentSearch;
                    searchMissingPersons();  // ê²€ìƒ‰ í•„í„° ì¬ì ìš©
                }
                
                const person = this.persons.find(p => p.id === personId);
                if (person) {
                    this.showToast(`ì„ íƒë¨: ${person.name || 'ì´ë¦„ ë¯¸ìƒ'}`, 'success');
                    
                    this.updateSearchRadiusInfo(person);
                    this.updateDriversInRangeInfo(person);
                    
                    if (this.map) {
                        let lat = person.lat;
                        let lng = person.lng;
                        
                        if (!lat || !lng || (lat === 36.5 && lng === 127.8)) {
                            if (person.location && this.geocoder) {
                                try {
                                    const coord = await this.geocodeAddress(person.location);
                                    lat = coord.lat;
                                    lng = coord.lng;
                                    
                                    person.lat = lat;
                                    person.lng = lng;
                                } catch (error) {
                                    console.log(`ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨: ${error}`);
                                }
                            }
                        }
                        
                        if (lat && lng && lat !== 36.5 && lng !== 127.8) {
                            const coords = new kakao.maps.LatLng(lat, lng);
                            this.map.setCenter(coords);
                            this.map.setLevel(3);
                            this.drawMovementArrows(person, lat, lng);
                        }
                    }
                }

                const cctvTab = document.querySelector('[onclick="switchTab(\'cctv\')"]');
                if (cctvTab) {
                    cctvTab.style.background = 'rgba(59, 130, 246, 0.1)';
                    cctvTab.style.borderLeft = '3px solid #3b82f6';
                    setTimeout(() => {
                        cctvTab.style.background = '';
                        cctvTab.style.borderLeft = '';
                    }, 2000);
                }
            }
            
            geocodeAddress(address) {
                return new Promise((resolve, reject) => {
                    if (!this.geocoder || !address) {
                        resolve({lat: 36.5, lng: 127.8});
                        return;
                    }
                    
                    this.geocoder.addressSearch(address, (result, status) => {
                        if (status === kakao.maps.services.Status.OK) {
                            resolve({
                                lat: parseFloat(result[0].y),
                                lng: parseFloat(result[0].x)
                            });
                        } else {
                            reject(new Error(`ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨: ${status}`));
                        }
                    });
                });
            }

            updateSearchRadiusInfo(person) {
                const infoDiv = document.getElementById('searchRadiusInfo');
                const radius = this.getSearchRadius(person);
                const description = this.getSearchDescription(person);
                
                infoDiv.innerHTML = `
                    <strong>ìˆ˜ìƒ‰ ë°˜ê²½: ${(radius/1000).toFixed(1)}km</strong><br>
                    ${description}
                `;
            }

            async updateDriversInRangeInfo(person) {
                const infoDiv = document.getElementById('driversInRange');
                infoDiv.innerHTML = 'ë²”ìœ„ ë‚´ ê¸°ì‚¬ ìˆ˜ë¥¼ ê³„ì‚° ì¤‘...';
                
                const driversInRange = await this.getDriversInRange(person.id);
                
                infoDiv.innerHTML = `
                    <strong>ë²”ìœ„ ë‚´ ì˜¨ë¼ì¸ ê¸°ì‚¬: ${driversInRange.length}ëª…</strong><br>
                    ${driversInRange.slice(0, 5).map(d => `${d.name}(${this.getDriverTypeName(d.type)})`).join(', ')}${driversInRange.length > 5 ? ` ì™¸ ${driversInRange.length - 5}ëª…` : ''}
                `;
            }
            
            updatePersonSelect() {
                const select = document.getElementById('personSelect');
                const currentValue = select.value;
                
                const options = this.persons.map(person => 
                    `<option value="${person.id}">${person.name || 'ì´ë¦„ ë¯¸ìƒ'} (${person.age || 'ë‚˜ì´ ë¯¸ìƒ'}ì„¸)</option>`
                ).join('');
                
                select.innerHTML = '<option value="">ì‹¤ì¢…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>' + options;
                
                if (currentValue) {
                    select.value = currentValue;
                }

                select.addEventListener('change', (e) => {
                    if (e.target.value) {
                        const person = this.persons.find(p => p.id === e.target.value);
                        if (person) {
                            this.updateSearchRadiusInfo(person);
                            this.updateDriversInRangeInfo(person);
                        }
                    }
                });
                
                // CCTV íƒ­ì˜ ì‹¤ì¢…ì ì„ íƒ ë“œë¡­ë‹¤ìš´ë„ ì—…ë°ì´íŠ¸
                const cctvSelect = document.getElementById('cctvPersonSelect');
                if (cctvSelect) {
                    cctvSelect.innerHTML = '<option value="">ì‹¤ì¢…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>' + options;
                    if (this.selectedPerson) {
                        cctvSelect.value = this.selectedPerson;
                    }
                }
            }
            
            addActivity(activity) {
                const container = document.getElementById('activityLog');
                const activityHtml = `
                    <div class="activity-item">
                        <div class="activity-time">${activity.time}</div>
                        <div class="activity-content">${activity.content}</div>
                    </div>
                `;
                
                container.insertAdjacentHTML('afterbegin', activityHtml);
                
                const items = container.querySelectorAll('.activity-item');
                if (items.length > 50) {
                    items[items.length - 1].remove();
                }
            }
            
            async updateStats() {
                try {
                    document.getElementById('totalActive').textContent = this.persons.length;
                    document.getElementById('highPriority').textContent = this.persons.filter(p => p.priority === 'HIGH').length;
                    document.getElementById('onlineDrivers').textContent = this.drivers.filter(d => d.status === 'online').length;
                    document.getElementById('firebaseStatus').textContent = this.isConnected ? 'ì—°ê²°ë¨' : 'ì—°ê²°ëŠê¹€';
                } catch (error) {
                    console.error('í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                }
            }
            
            initEventListeners() {
                const form = document.getElementById('notificationForm');
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendManualNotification();
                });
                
                const driverForm = document.getElementById('driverForm');
                driverForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    registerDriver();
                });
            }
            
            async sendManualNotification() {
                const personId = document.getElementById('personSelect').value;
                const notificationType = document.getElementById('notificationType').value;
                
                if (!personId) {
                    this.showToast('ì‹¤ì¢…ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                const person = this.persons.find(p => p.id === personId);
                if (!person) {
                    this.showToast('ì‹¤ì¢…ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                try {
                    this.addActivity({
                        time: new Date().toLocaleTimeString(),
                        content: `ì‹¤ì¢…ì ${person.name || 'ì´ë¦„ ë¯¸ìƒ'} ì•Œë¦¼ ì „ì†¡ ì¤‘...`
                    });

                    let targetTokens = [];
                    let message = '';
                    
                    if (notificationType === 'smart') {
                        const driversInRange = await this.getDriversInRange(person.id);
                        
                        if (driversInRange.length === 0) {
                            this.showToast('ë²”ìœ„ ë‚´ ì˜¨ë¼ì¸ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                            return;
                        }
                        
                        targetTokens = driversInRange.map(d => `token_${d.id}`);
                        message = `[ìŠ¤ë§ˆíŠ¸ ì „ì†¡] ${person.name || 'ì´ë¦„ ë¯¸ìƒ'}ë‹˜ì„ ì°¾ì•„ì£¼ì„¸ìš”`;
                        
                        this.addActivity({
                            time: new Date().toLocaleTimeString(),
                            content: `ë²”ìœ„ ë‚´ ${driversInRange.length}ëª…ì˜ ê¸°ì‚¬ì—ê²Œ ì „ì†¡`
                        });
                    } else if (notificationType === 'test') {
                        targetTokens = ['test_token'];
                        message = `[í…ŒìŠ¤íŠ¸] ${person.name || 'ì´ë¦„ ë¯¸ìƒ'}ë‹˜ì„ ì°¾ì•„ì£¼ì„¸ìš”`;
                    } else if (notificationType === 'all') {
                        const onlineDrivers = this.drivers.filter(d => d.status === 'online');
                        targetTokens = onlineDrivers.map(d => `token_${d.id}`);
                        message = `[ì „ì²´ ì „ì†¡] ${person.name || 'ì´ë¦„ ë¯¸ìƒ'}ë‹˜ì„ ì°¾ì•„ì£¼ì„¸ìš”`;
                        
                        if (targetTokens.length === 0) {
                            this.showToast('ì˜¨ë¼ì¸ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                            return;
                        }
                    }

                    const requestData = {
                        person_id: person.id,
                        message: message,
                        priority: person.priority || 'MEDIUM',
                        target_tokens: targetTokens,
                        test_mode: notificationType === 'test'
                    };

                    console.log('ì „ì†¡ ë°ì´í„°:', requestData);

                    const response = await fetch(`${API_BASE_URL}/api/send_notification`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        this.showToast(`ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ (${targetTokens.length}ëª…)`, 'success');
                        this.showResult('ì•Œë¦¼ ì „ì†¡ ê²°ê³¼', {
                            ì‹¤ì¢…ì: person.name || 'ì´ë¦„ ë¯¸ìƒ',
                            ì¹´í…Œê³ ë¦¬: person.category || 'ë¯¸ì§€ì •',
                            ìˆ˜ìƒ‰ë°˜ê²½: `${(this.getSearchRadius(person)/1000).toFixed(1)}km`,
                            ì „ì†¡ë°©ì‹: notificationType === 'smart' ? 'ìŠ¤ë§ˆíŠ¸ ì „ì†¡' : (notificationType === 'test' ? 'í…ŒìŠ¤íŠ¸ ì „ì†¡' : 'ì „ì²´ ì „ì†¡'),
                            ëŒ€ìƒê¸°ì‚¬ìˆ˜: targetTokens.length
                        });
                        
                        this.addActivity({
                            time: new Date().toLocaleTimeString(),
                            content: `ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ: ${person.name || 'ì´ë¦„ ë¯¸ìƒ'} (${targetTokens.length}ëª…)`
                        });
                    } else {
                        console.error('ì „ì†¡ ì‹¤íŒ¨:', result);
                        this.showToast(`ì „ì†¡ ì‹¤íŒ¨: ${result.detail || JSON.stringify(result)}`, 'error');
                    }

                } catch (error) {
                    console.error('ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜:', error);
                    this.showToast(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                }
            }
            
            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type === 'error' ? 'error' : ''}`;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
            
            showResult(title, data) {
                const resultDiv = document.getElementById('testResults');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `${title}:\n${JSON.stringify(data, null, 2)}`;
                
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 10000);
            }

            getDriverTypeName(type) {
                const types = {
                    'taxi': 'íƒì‹œ',
                    'delivery': 'ë°°ë‹¬'
                };
                return types[type] || type;
            }
            
            getPersonById(personId) {
                return this.persons.find(p => p.id === personId);
            }

            getAllPersons() {
                return this.persons.filter(p => p.status === 'ACTIVE');
            }

            async loadAllCCTVs() {
                console.log("âœ… CCTV JS ìµœì‹ ë²„ì „ ë¡œë“œë¨");
                try {
                    console.log('ì „ì²´ CCTV ë¡œë“œ ì‹œì‘...');
                    const response = await fetch(`${API_BASE_URL}/api/all_cctvs`);
                    console.log("ì‘ë‹µ ìƒíƒœ:", response.status);
                    const text = await response.text();
                    console.log("ì‘ë‹µ ì›ë¬¸:", text.slice(0, 200)); // ë§¨ ì• 200ìë§Œ
                    const data = JSON.parse(text);
                    this.allCCTVs = data.cctvs || [];
                    console.log(`CCTV ${this.allCCTVs.length}ê°œ ë¡œë“œë¨`);
                    this.displayCCTVMarkers();
                } catch (error) {
                    console.error('ì „ì²´ CCTV ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }

            displayCCTVMarkers() {
                console.log("=== CCTV ë§ˆì»¤ í‘œì‹œ ì‹œë„ ===");
                console.log("ì§€ë„ ê°ì²´:", this.map);
                console.log("ì „ì²´ CCTV ë°°ì—´ íƒ€ì…:", Array.isArray(this.allCCTVs));
                console.log("CCTV ê°œìˆ˜:", this.allCCTVs?.length);
                console.log("ì²« ì¢Œí‘œ:", this.allCCTVs?.[0]?.coords);
                    
                if (!this.map) {
                    console.log('ì§€ë„ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                    return;
                }

                this.clearCCTVMarkers();

                if (!this.showCCTVMarkers) {
                    console.log('CCTV ë§ˆì»¤ í‘œì‹œ êº¼ì§');
                    return;
                }

                console.log(`CCTV ë§ˆì»¤ í‘œì‹œ ì‹œì‘: ${this.allCCTVs.length}ê°œ`);
                console.log("ë¡œë“œëœ CCTV ì˜ˆì‹œ:", this.allCCTVs[0]);

                // âœ… ì—¬ê¸°ì„œ coords ë§¤í•‘ ë³´ì • (í˜¹ì‹œ êµ¬ì¡° ë‹¤ë¥¼ ë•Œ ëŒ€ë¹„)
                this.allCCTVs = this.allCCTVs.map(c => ({
                    ...c,
                    coords: c.coords || { lat: c.YCOORD, lng: c.XCOORD }
                }));

                this.allCCTVs.forEach(cctv => {
                    if (!cctv.coords || cctv.coords.lat == null || cctv.coords.lng == null) return;

                    // ğŸ”¥ ì¢Œí‘œ ìˆœì„œ ë°”ê¿”ì„œ ì°ê¸°
                    const markerPosition = new kakao.maps.LatLng(cctv.coords.lat, cctv.coords.lng);
                    // â†“ ê·¸ë˜ë„ ì•ˆ ëœ¨ë©´ ì•„ë˜ì²˜ëŸ¼ ìˆœì„œ ë°”ê¿”ì„œ í•œë²ˆ ë” ì‹œë„
                    // const markerPosition = new kakao.maps.LatLng(cctv.coords.lng, cctv.coords.lat);

                    function btoaUTF8(str) {
                        return window.btoa(unescape(encodeURIComponent(str)));
                    }

                    const markerImage = new kakao.maps.MarkerImage(
                        'data:image/svg+xml;base64,' + btoaUTF8(`
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="32" height="32">
                                <circle cx="16" cy="16" r="14" fill="#4338ca" stroke="white" stroke-width="2"/>
                                <text x="16" y="21" text-anchor="middle" fill="white" font-size="16">ğŸ“¹</text>
                            </svg>
                        `),
                        new kakao.maps.Size(32, 32)
                    );

                    const marker = new kakao.maps.Marker({
                        position: markerPosition,
                        map: this.map,
                        image: markerImage,
                        title: cctv.name
                    });

                    const infoContent = `
                        <div style="padding: 12px; min-width: 220px; max-width: 300px;">
                            <div style="font-weight: 700; margin-bottom: 10px; color: #1e293b; font-size: 14px;">${cctv.name}</div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">${cctv.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</div>
                            <button onclick="admin.openCCTVPopup('${cctv.id}')"
                                    style="width: 100%; padding: 8px 12px; background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                ì‹¤ì‹œê°„ ì˜ìƒ ë³´ê¸°
                            </button>
                        </div>
                    `;

                    const infowindow = new kakao.maps.InfoWindow({
                        content: infoContent,
                        removable: true
                    });

                    kakao.maps.event.addListener(marker, 'click', () => {
                        infowindow.open(this.map, marker);
                    });

                    this.cctvMarkers.push(marker);
                });

                console.log(`âœ… CCTV ë§ˆì»¤ ${this.cctvMarkers.length}ê°œ ìƒì„± ì™„ë£Œ`);

                if (this.cctvMarkers.length > 0) {
                    const bounds = new kakao.maps.LatLngBounds();
                    this.cctvMarkers.forEach(marker => bounds.extend(marker.getPosition()));
                    this.map.setBounds(bounds);
                    console.log("ì§€ë„ ì¤‘ì‹¬ ìë™ ì¡°ì • ì™„ë£Œ âœ…");
                } else {
                    console.warn("âš ï¸ ìƒì„±ëœ ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }

            }

            clearCCTVMarkers() {
                this.cctvMarkers.forEach(marker => marker.setMap(null));
                this.cctvMarkers = [];
            }

            toggleCCTVMarkers() {
                this.showCCTVMarkers = !this.showCCTVMarkers;
                if (this.showCCTVMarkers) {
                    this.displayCCTVMarkers();
                } else {
                    this.clearCCTVMarkers();
                }
            }

            openCCTVPopup(cctvId) {
                const cctv = this.allCCTVs.find(c => c.id === cctvId);
                if (!cctv) return;
                
                const popup = window.open('', 'CCTVì˜ìƒ', 'width=640,height=480');
                popup.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>${cctv.name}</title>
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { 
                                background: #000; 
                                overflow: hidden; 
                                height: 100vh;
                                display: flex;
                                flex-direction: column;
                            }
                            .video-container { 
                                flex: 1;
                                width: 100%; 
                                overflow: hidden; 
                                position: relative;
                                min-height: 0;
                            }
                            iframe { 
                                width: 100%; 
                                height: 100%; 
                                border: none; 
                                display: block;
                            }
                            .info { 
                                background: #4a5568; 
                                color: #60a5fa; 
                                padding: 10px 15px; 
                                font-size: 14px; 
                                font-weight: 600;
                                flex-shrink: 0;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="video-container">
                            <iframe src="${cctv.stream_url}" loading="eager" allowfullscreen></iframe>
                        </div>
                        <div class="info">${cctv.name}</div>
                    </body>
                    </html>
                `);
            }
        }
        
        let admin;
        
        async function testAPI() {
            const btn = event.target;
            btn.classList.add('loading');
            btn.textContent = 'í…ŒìŠ¤íŠ¸ ì¤‘...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/missing_persons`);
                const data = await response.json();
                admin.showResult('API í…ŒìŠ¤íŠ¸ ê²°ê³¼', data);
                admin.showToast('API í…ŒìŠ¤íŠ¸ ì„±ê³µ', 'success');
            } catch (error) {
                admin.showToast(`API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.classList.remove('loading');
                btn.textContent = 'API í…ŒìŠ¤íŠ¸';
            }
        }
        
        async function testFirebase() {
            const btn = event.target;
            btn.classList.add('loading');
            btn.textContent = 'í…ŒìŠ¤íŠ¸ ì¤‘...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/send_notification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        person: {
                            id: 'test_001',
                            name: 'í…ŒìŠ¤íŠ¸ ì‹¤ì¢…ì',
                            age: 30,
                            priority: 'HIGH',
                            location: 'í…ŒìŠ¤íŠ¸ ìœ„ì¹˜'
                        },
                        target_tokens: ['test_token'],
                        test_mode: true
                    })
                });
                
                const result = await response.json();
                admin.showResult('Firebase í…ŒìŠ¤íŠ¸ ê²°ê³¼', result);
                admin.showToast('Firebase í…ŒìŠ¤íŠ¸ ì™„ë£Œ', 'success');
            } catch (error) {
                admin.showToast(`Firebase í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.classList.remove('loading');
                btn.textContent = 'Firebase í…ŒìŠ¤íŠ¸';
            }
        }
        
        async function testStatistics() {
            const btn = event.target;
            btn.classList.add('loading');
            btn.textContent = 'í™•ì¸ ì¤‘...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/statistics`);
                const data = await response.json();
                admin.showResult('ì‹œìŠ¤í…œ í†µê³„', data);
                admin.showToast('í†µê³„ ì¡°íšŒ ì™„ë£Œ', 'success');
            } catch (error) {
                admin.showToast(`í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.classList.remove('loading');
                btn.textContent = 'í†µê³„ í™•ì¸';
            }
        }
        
        async function forceUpdate() {
            const btn = event.target;
            btn.classList.add('loading');
            btn.textContent = 'ì—…ë°ì´íŠ¸ ì¤‘...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/force_update`, {
                    method: 'POST'
                });
                const data = await response.json();
                admin.showResult('ìˆ˜ë™ ì—…ë°ì´íŠ¸ ê²°ê³¼', data);
                admin.showToast('ìˆ˜ë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'success');
                
                await admin.loadInitialData();
            } catch (error) {
                admin.showToast(`ìˆ˜ë™ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.classList.remove('loading');
                btn.textContent = 'ìˆ˜ë™ ì—…ë°ì´íŠ¸';
            }
        }
        
        function initKakaoMap() {
            admin.initializeKakaoMap();
        }
        
        window.onload = () => {
            admin = new AdminDashboard();
        };

        // ëŒ€ê¸° ì¤‘ì¸ ì‹ ê³  ëª©ë¡ ë¡œë“œ
        async function loadPendingReports() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/pending_reports`);
                const data = await response.json();
                
                document.getElementById('pendingReportsCount').textContent = data.count || 0;
                
                const container = document.getElementById('pendingReportsList');
                
                if (!data.reports || data.reports.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #9ca3af;">ëŒ€ê¸° ì¤‘ì¸ ì‹ ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                const html = data.reports.map(report => `
                    <div class="person-card" style="border-left: 4px solid #f59e0b;">
                        <div style="display: flex; gap: 1rem;">
                            ${report.photo_base64 ? `
                                <img src="${report.photo_base64}" 
                                     style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover;">
                            ` : `
                                <div style="width: 80px; height: 80px; background: #f3f4f6; border-radius: 8px; 
                                            display: flex; align-items: center; justify-content: center;">
                                    <span style="font-size: 2rem;">ğŸ‘¤</span>
                                </div>
                            `}
                            
                            <div style="flex: 1;">
                                <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">
                                    ${report.name || 'ì´ë¦„ ë¯¸ìƒ'}
                                </h3>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span class="person-badge">${report.age || '?'}ì„¸</span>
                                    <span class="person-badge">${report.gender || '?'}</span>
                                    <span class="person-badge category-badge">${report.category || 'ê¸°íƒ€'}</span>
                                </div>
                                <p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">
                                    <strong>ì‹¤ì¢… ì¥ì†Œ:</strong> ${report.location || 'ì •ë³´ ì—†ìŒ'}
                                </p>
                                <p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">
                                    <strong>ì‹¤ì¢… ì‹œê°:</strong> ${formatDateTime(report.last_seen)}
                                </p>
                                <p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">
                                    <strong>ì‹ ê³  ì ‘ìˆ˜:</strong> ${formatDateTime(report.created_at)}
                                </p>
                                ${report.emergency_contact ? `
                                    <p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">
                                        <strong>ì—°ë½ì²˜:</strong> ${report.emergency_contact}
                                    </p>
                                ` : ''}
                                ${report.description ? `
                                    <p style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                                        ${report.description}
                                    </p>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="approveReport('${report.id}')" style="flex: 1;">
                                ìŠ¹ì¸
                            </button>
                            <button class="btn" onclick="rejectReport('${report.id}')" 
                                    style="flex: 1; background: #ef4444; color: white;">
                                ê±°ì ˆ
                            </button>
                            <button class="btn btn-secondary" onclick="showReportDetail('${report.id}')">
                                ìƒì„¸
                            </button>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('ëŒ€ê¸° ì‹ ê³  ë¡œë“œ ì‹¤íŒ¨:', error);
                admin.showToast('ì‹ ê³  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }

        // ì‹ ê³  ìŠ¹ì¸
        async function approveReport(reportId) {
            if (!confirm('ì´ ì‹¤ì¢…ì ì‹ ê³ ë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/missing_persons/${reportId}/approve`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (response.ok) {
                    admin.showToast('ì‹ ê³ ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    admin.addActivity({
                        time: new Date().toLocaleTimeString(),
                        content: `ì‹¤ì¢…ì ì‹ ê³  ìŠ¹ì¸`
                    });
                    await loadPendingReports();
                    await loadApprovedPersons();
                } else {
                    admin.showToast('ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                }
            } catch (error) {
                console.error('ìŠ¹ì¸ ì˜¤ë¥˜:', error);
                admin.showToast('ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // ì‹ ê³  ê±°ì ˆ
        async function rejectReport(reportId) {
            const reason = prompt('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
            if (!reason) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/missing_persons/${reportId}/reject`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(reason)
                });
                
                if (response.ok) {
                    admin.showToast('ì‹ ê³ ê°€ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    admin.addActivity({
                        time: new Date().toLocaleTimeString(),
                        content: `ì‹¤ì¢…ì ì‹ ê³  ê±°ì ˆ`
                    });
                    await loadPendingReports();
                } else {
                    admin.showToast('ê±°ì ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                }
            } catch (error) {
                console.error('ê±°ì ˆ ì˜¤ë¥˜:', error);
                admin.showToast('ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // ìŠ¹ì¸ëœ ì‹¤ì¢…ì ëª©ë¡ ë¡œë“œ
        async function loadApprovedPersons() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/missing_persons`);
                const data = await response.json();
                
                const container = document.getElementById('approvedPersonsList');
                
                if (!container) {
                    console.error('approvedPersonsList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                if (!data.persons || data.persons.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #9ca3af;">ìŠ¹ì¸ëœ ì‹¤ì¢…ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                const html = data.persons.map(person => `
                    <div class="person-card" style="border-left: 4px solid #10b981; margin-bottom: 0.75rem;">
                        <div style="display: flex; gap: 1rem; align-items: start;">
                            ${(() => {
                                const photoData = person.photo_url || person.photo_base64;
                                if (photoData) {
                                    const photoSrc = photoData.startsWith('data:') ? photoData : `data:image/jpeg;base64,${photoData}`;
                                    return `<img src="${photoSrc}" 
                                                style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;">`;
                                } else {
                                    return `<div style="width: 60px; height: 60px; background: #f3f4f6; border-radius: 8px; 
                                                        display: flex; align-items: center; justify-content: center;">
                                                <span style="font-size: 1.5rem;">ğŸ‘¤</span>
                                            </div>`;
                                }
                            })()}
                            
                            <div style="flex: 1;">
                                <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.3rem;">
                                    ${person.name || 'ì´ë¦„ ë¯¸ìƒ'}
                                </h4>
                                <div style="display: flex; gap: 0.3rem; margin-bottom: 0.3rem; flex-wrap: wrap;">
                                    <span class="person-badge" style="font-size: 0.75rem;">${person.age || '?'}ì„¸</span>
                                    <span class="person-badge" style="font-size: 0.75rem;">${person.gender || '?'}</span>
                                    <span class="person-badge category-badge" style="font-size: 0.75rem;">${person.category || 'ê¸°íƒ€'}</span>
                                    ${person.source === 'REPORTER' ? 
                                        '<span class="person-badge" style="font-size: 0.75rem; background: #3b82f6; color: white;">ì‹ ê³ </span>' : 
                                        '<span class="person-badge" style="font-size: 0.75rem; background: #8b5cf6; color: white;">API</span>'}
                                </div>
                                <p style="font-size: 0.85rem; color: #6b7280;">
                                    ${person.location || 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ'}
                                </p>
                            </div>
                            
                            <button class="btn" onclick="event.stopPropagation(); deletePerson('${person.id}')" 
                                    style="background: #ef4444; color: white; padding: 0.5rem 1rem; font-size: 0.875rem; 
                                        border: none; border-radius: 6px; cursor: pointer; white-space: nowrap;">
                                ì‚­ì œ
                            </button>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = html;
                
                console.log(`ìŠ¹ì¸ëœ ì‹¤ì¢…ì ${data.persons.length}ëª… í‘œì‹œë¨`);
                
            } catch (error) {
                console.error('ìŠ¹ì¸ëœ ì‹¤ì¢…ì ë¡œë“œ ì‹¤íŒ¨:', error);
                const container = document.getElementById('approvedPersonsList');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">ì‹¤ì¢…ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            }
        }

        // ì‹¤ì¢…ì ì‚­ì œ
        async function deletePerson(personId) {
            if (!confirm('ì´ ì‹¤ì¢…ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/missing_persons/${personId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    admin.showToast('ì‹¤ì¢…ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    admin.addActivity({
                        time: new Date().toLocaleTimeString(),
                        content: `ì‹¤ì¢…ì ì‚­ì œ`
                    });
                    
                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    await loadApprovedPersons();
                    await admin.loadInitialData();
                } else {
                    const error = await response.json();
                    admin.showToast(`ì‚­ì œ ì‹¤íŒ¨: ${error.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                }
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                admin.showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // ì‹¤ì¢…ì ê²€ìƒ‰
        function searchApprovedPersons() {
            const searchTerm = document.getElementById('approvedPersonSearch').value.toLowerCase();
            const cards = document.querySelectorAll('#approvedPersonsList .person-card');
            
            cards.forEach(card => {
                const name = card.querySelector('h4').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
        function formatDateTime(dateString) {
            if (!dateString) return 'ì •ë³´ ì—†ìŒ';
            try {
                const date = new Date(dateString);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            } catch {
                return dateString;
            }
        }

        // ì‹ ê³  ìƒì„¸ ë³´ê¸°
        async function showReportDetail(reportId) {
            showPersonDetail(reportId);
        }

        // ì‹¤ì¢…ì ê²€ìƒ‰ í•¨ìˆ˜
        function searchMissingPersons() {
            const searchTerm = document.getElementById('missingPersonSearch').value.toLowerCase();
            const personCards = document.querySelectorAll('#personList .person-item');
            
            let visibleCount = 0;
            
            personCards.forEach(card => {
                // .person-name í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ìš”ì†Œì—ì„œ ì´ë¦„ ì¶”ì¶œ
                const nameElement = card.querySelector('.person-name');
                
                if (nameElement) {
                    const nameText = nameElement.textContent.toLowerCase();
                    
                    // ê²€ìƒ‰ì–´ê°€ ì´ë¦„ì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ í‘œì‹œ
                    if (nameText.includes(searchTerm)) {
                        card.style.display = 'flex';  // person-itemì€ flex ë ˆì´ì•„ì›ƒ ì‚¬ìš©
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
            
            // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ í‘œì‹œ (ì„ íƒì‚¬í•­)
            const container = document.getElementById('personList');
            let noResultsMsg = container.querySelector('.no-results-message');
            
            if (visibleCount === 0 && searchTerm.length > 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'no-results-message';
                    noResultsMsg.style.cssText = 'text-align: center; padding: 2rem; color: #9ca3af;';
                    noResultsMsg.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
                    container.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
            
            console.log(`ê²€ìƒ‰ ê²°ê³¼: "${searchTerm}" - ${visibleCount}ëª… í‘œì‹œ`);
        }

        // ëª©ê²© ì‹ ê³  ë‚´ì—­ ë¡œë“œ
        async function loadSightingReports(status = 'all') {
            const container = document.getElementById('sightingReportsList');
            if (!container) return;
            
            try {
                const response = await fetch(`http://localhost:8001/api/sighting_reports?status=${status}`);
                
                if (!response.ok) {
                    throw new Error('ì„œë²„ ì˜¤ë¥˜');
                }
                
                const data = await response.json();
                
                if (data.reports.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">ëª©ê²© ì‹ ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                container.innerHTML = data.reports.map(report => {
                    const statusText = {
                        'PENDING': 'ëŒ€ê¸°ì¤‘',
                        'REVIEWING': 'ê²€í† ì¤‘',
                        'CONFIRMED': 'í™•ì¸ë¨',
                        'REJECTED': 'ê¸°ê°ë¨'
                    }[report.status] || 'ëŒ€ê¸°ì¤‘';
                    
                    const confidenceText = {
                        'HIGH': 'í™•ì‹¤í•¨',
                        'MEDIUM': 'ë³´í†µ',
                        'LOW': 'ë¶ˆí™•ì‹¤í•¨'
                    }[report.confidence_level] || 'ë³´í†µ';
                    
                    let photoHtml = '';
                    if (report.person_photo) {
                        let photoSrc = report.person_photo;
                        if (!photoSrc.startsWith('data:')) {
                            photoSrc = `data:image/jpeg;base64,${photoSrc}`;
                        }
                        photoHtml = `
                            <div style="width: 80px; height: 80px; border-radius: 8px; overflow: hidden; flex-shrink: 0; background: #f3f4f6;">
                                <img src="${photoSrc}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none';">
                            </div>
                        `;
                    } else {
                        photoHtml = `
                            <div style="width: 80px; height: 80px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #f3f4f6; flex-shrink: 0;">
                                <span style="font-size: 2rem;">ğŸ‘¤</span>
                            </div>
                        `;
                    }
                    
                    const reportTime = report.reported_at ? new Date(report.reported_at).toLocaleString('ko-KR') : 'ì‹œê°„ ë¯¸ìƒ';
                    const personName = report.person_name || 'ì´ë¦„ ë¯¸ìƒ';
                    const reportLat = report.reporter_lat ? report.reporter_lat.toFixed(6) : 'N/A';
                    const reportLng = report.reporter_lng ? report.reporter_lng.toFixed(6) : 'N/A';
                    const description = report.description || 'ì„¤ëª… ì—†ìŒ';
                    
                    return `
                        <div class="report-card" style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); ${report.status === 'CONFIRMED' ? 'border: 2px solid #10b981;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="display: flex; gap: 12px; flex: 1;">
                                    ${photoHtml}
                                    <div style="flex: 1;">
                                        <div style="font-weight: 700; font-size: 1rem; margin-bottom: 4px; color: #1e293b;">
                                            ${personName}
                                            <span style="font-size: 11px; background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 12px; margin-left: 8px;">
                                                ${confidenceText}
                                            </span>
                                        </div>
                                        <div style="font-size: 12px; color: #64748b;">#${report.id} | ${reportTime}</div>
                                    </div>
                                </div>
                                <span style="font-size: 12px; padding: 4px 12px; border-radius: 6px; font-weight: 600; white-space: nowrap;
                                    ${report.status === 'CONFIRMED' ? 'background: #d1fae5; color: #065f46;' : 
                                    report.status === 'REVIEWING' ? 'background: #dbeafe; color: #1e40af;' : 
                                    report.status === 'REJECTED' ? 'background: #fee2e2; color: #991b1b;' : 
                                    'background: #fef3c7; color: #92400e;'}">
                                    ${statusText}
                                </span>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 13px;">
                                <div style="margin-bottom: 6px;"><strong>ìœ„ì¹˜:</strong> ${reportLat}, ${reportLng}</div>
                                <div><strong>ì„¤ëª…:</strong> ${description}</div>
                            </div>
                            
                            ${report.status === 'PENDING' || report.status === 'REVIEWING' ?
                                `
                                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                        ${report.status === 'PENDING' ? `
                                            <button style="padding: 6px 12px; font-size: 12px; border: none; border-radius: 6px; cursor: pointer; background: #6b7280; color: white;" onclick="updateReportStatus('${report.id}', 'REVIEWING')">
                                                ê²€í† ì¤‘
                                            </button>
                                        ` : ''}
                                        <button style="padding: 6px 12px; font-size: 12px; border: none; border-radius: 6px; cursor: pointer; background: #10b981; color: white;" onclick="confirmReport('${report.id}', '${personName}')">
                                            ë°œê²¬ í™•ì¸
                                        </button>
                                        <button style="padding: 6px 12px; font-size: 12px; border: none; border-radius: 6px; cursor: pointer; background: #ef4444; color: white;" onclick="updateReportStatus('${report.id}', 'REJECTED')">
                                            ê¸°ê°
                                        </button>
                                    </div>
                                ` : `
                                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                        <button style="padding: 6px 12px; font-size: 12px; border: none; border-radius: 6px; cursor: pointer; background: #ef4444; color: white;" onclick="deleteReport('${report.id}')">
                                            ì‚­ì œ
                                        </button>
                                    </div>
                                `}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('ëª©ê²© ì‹ ê³  ë¡œë“œ ì˜¤ë¥˜:', error);
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
            }
        }

        async function confirmReport(reportId, personName) {
            if (!confirm(`${personName}ë‹˜ì„ ë°œê²¬í–ˆìŠµë‹ˆê¹Œ?\n\nì´ ì‹ ê³ ë¥¼ "í™•ì¸ë¨"ìœ¼ë¡œ ì²˜ë¦¬í•˜ë©´ ì‹¤ì¢…ìê°€ "ì°¾ìŒ" ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤.`)) {
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:8001/api/sighting_report/${reportId}/status?status=CONFIRMED`, {
                    method: 'PATCH'
                });
                
                if (!response.ok) {
                    throw new Error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }
                
                const result = await response.json();
                
                if (result.person_found) {
                    alert('ì‹¤ì¢…ìê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì‹¤ì¢…ì ëª©ë¡ì´ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.');
                    // ì‹¤ì¢…ì ëª©ë¡ë„ ìƒˆë¡œê³ ì¹¨
                    if (typeof loadMissingPersons === 'function') {
                        loadMissingPersons();
                    }
                }
                
                loadSightingReports(document.getElementById('reportStatusFilter').value);
            } catch (error) {
                console.error('í™•ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('í™•ì¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        async function updateReportStatus(reportId, status) {
            try {
                const response = await fetch(`http://localhost:8001/api/sighting_report/${reportId}/status?status=${status}`, {
                    method: 'PATCH'
                });
                
                if (!response.ok) {
                    throw new Error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }
                
                loadSightingReports(document.getElementById('reportStatusFilter').value);
            } catch (error) {
                console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                alert('ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        async function deleteReport(reportId) {
            if (!confirm('ì´ ì‹ ê³ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                console.log('ì‚­ì œ ìš”ì²­:', reportId);
                
                const response = await fetch(`http://localhost:8001/api/sighting_report/${reportId}`, {
                    method: 'DELETE'
                });
                
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('ì‚­ì œ ì‹¤íŒ¨:', errorData);
                    throw new Error(errorData.detail || 'ì‚­ì œ ì‹¤íŒ¨');
                }
                
                const result = await response.json();
                console.log('ì‚­ì œ ì„±ê³µ:', result);
                
                alert('ì‹ ê³ ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                loadSightingReports(document.getElementById('reportStatusFilter').value);
                
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                alert(`ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        // WebSocket ì—°ê²°
        let reportWebSocket = null;
        
        function connectReportWebSocket() {
            try {
                reportWebSocket = new WebSocket('ws://localhost:8001/ws/admin');
                
                reportWebSocket.onopen = function() {
                    console.log('ëª©ê²© ì‹ ê³  WebSocket ì—°ê²°ë¨');
                };
                
                reportWebSocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    console.log('WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ :', data);
                    
                    if (data.type === 'new_sighting_report') {
                        // ì•Œë¦¼ í‘œì‹œ
                        if (confirm(`ìƒˆë¡œìš´ ëª©ê²© ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!\nì‹ ê³  ID: #${data.report_id}\n\nëª©ê²© ì‹ ê³  íƒ­ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                            switchTab('sighting');
                            loadSightingReports();
                        }
                        
                        // ì‹ ê³  ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                        const reportCount = document.getElementById('reportCount');
                        if (reportCount) {
                            const currentCount = parseInt(reportCount.textContent) || 0;
                            reportCount.textContent = currentCount + 1;
                            reportCount.style.animation = 'pulse 1s ease-in-out 3';
                        }
                    }
                };
                
                reportWebSocket.onerror = function(error) {
                    console.error('WebSocket ì˜¤ë¥˜:', error);
                };
                
                reportWebSocket.onclose = function() {
                    console.log('WebSocket ì—°ê²° ì¢…ë£Œ. 5ì´ˆ í›„ ì¬ì—°ê²°...');
                    setTimeout(connectReportWebSocket, 5000);
                };
            } catch (error) {
                console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ëŒ€ì‹œë³´ë“œ ë¡œë”© ì™„ë£Œ');
            connectReportWebSocket();
        });
        
        // switchTab í•¨ìˆ˜ê°€ ìˆë‹¤ë©´ í™•ì¥
        const originalSwitchTab = window.switchTab;
        if (originalSwitchTab) {
            window.switchTab = function(tabName) {
                originalSwitchTab(tabName);
                if (tabName === 'sighting') {
                    loadSightingReports();
                }
            };
        }

    </script>
</body>
</html>